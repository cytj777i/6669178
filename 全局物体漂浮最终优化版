local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- ç­‰å¾…æ¸¸æˆåŠ è½½å®Œæˆ
if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- ç­‰å¾…æœ¬åœ°ç©å®¶åŠ è½½
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    LocalPlayer = Players.LocalPlayer
end

-- æ˜¾ç¤ºä½œè€…ä¿¡æ¯
local authorMessage = Instance.new("Message")
authorMessage.Text = "å…¨å±€ç‰©ä½“æ¼‚æµ®è„šæœ¬ - ä½œè€…: ciTiy\næ­¤è„šæœ¬ä¸ºå…è´¹è„šæœ¬ï¼Œè¢«å€’å–éª—äº†æˆ‘ä¸è´Ÿè´£ğŸ˜±\nåˆ¶ä½œçµæ„Ÿæ¥æºäºåé‡åŠ›çŠ¶æ€è„šæœ¬\n1ï¼šæ­¤è„šæœ¬çš„æ§åˆ¶æŒ‰é”®æœ€å¥½ä¸è¦çŸ­æ—¶é—´å†…è¿ç»­ç‚¹å‡»å¹¶é•¿æŒ‰ï¼Œä¼šå‡ºç°é¢œè‰²æ•…éšœ\n2ï¼šæŒ‰äº†åœæ­¢æ—‹è½¬æŒ‰é’®åå¯ä»¥ç«™åœ¨æ§åˆ¶çš„ç‰©ä½“ä¸Šé¢å¾¡ç‰©é£è¡Œ\n3ï¼šæ§åˆ¶é¢æ¿uiè°ƒèŠ‚æŒ‰é’®åœ¨æœ€åº•ä¸‹\n4ï¼šæ›´æ–°äº†é€Ÿåº¦ä¸Šé™ï¼Œç°åœ¨å¯ä»¥è°ƒæ›´å¿«äº†"
authorMessage.Parent = Workspace
delay(5, function()
    authorMessage:Destroy()
end)

-- å…¨å±€å˜é‡
_G.processedParts = {}
_G.floatSpeed = 10 -- é»˜è®¤æ¼‚æµ®é€Ÿåº¦
_G.moveDirectionType = "up" -- é»˜è®¤ç§»åŠ¨æ–¹å‘ç±»å‹
_G.moveDirection = Vector3.new(0, 1, 0) -- é»˜è®¤å‘ä¸Šç§»åŠ¨
_G.fixedMode = false -- å›ºå®šæ¨¡å¼å¼€å…³ï¼ˆé˜²æ­¢æ—‹è½¬ï¼‰

-- æ­»äº¡çŠ¶æ€æ£€æµ‹å˜é‡
local isPlayerDead = false
local characterAddedConnection = nil
local humanoidDiedConnection = nil

-- GUIå¼•ç”¨
local screenGui = nil
local mainButton = nil
local controlPanel = nil
local fixButton = nil -- é˜²æ­¢æ—‹è½¬æŒ‰é’®çš„å…¨å±€å¼•ç”¨
local openPanelButton = nil

-- è®¾ç½®æ¨¡æ‹ŸåŠå¾„
local function setupSimulationRadius()
    local success, err = pcall(function()
        RunService.Heartbeat:Connect(function()
            pcall(function()
                sethiddenproperty(LocalPlayer, "SimulationRadius", math.huge)
                sethiddenproperty(LocalPlayer, "MaxSimulationRadius", math.huge)
            end)
        end)
    end)

    if not success then
        warn("æ¨¡æ‹ŸåŠå¾„è®¾ç½®å¤±è´¥: " .. tostring(err))
    end
end

setupSimulationRadius()

-- ç©å®¶æ­»äº¡çŠ¶æ€æ£€æµ‹å’Œè‡ªåŠ¨é‡è¿å‡½æ•°
local function setupDeathDetectionAndReconnect()
    local function onCharacterAdded(character)
        -- é‡ç½®æ­»äº¡çŠ¶æ€
        isPlayerDead = false
        print("è§’è‰²é‡ç”Ÿï¼Œæ­»äº¡çŠ¶æ€é‡ç½®")

        -- é‡æ–°è®¾ç½®æ¨¡æ‹ŸåŠå¾„
        setupSimulationRadius()

        -- å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€
        anActivity = false
        _G.fixedMode = false
        CleanupParts()

        -- ç¡®ä¿GUIå­˜åœ¨ä¸”çŠ¶æ€æ­£ç¡®
        if screenGui and screenGui.Parent then
            -- GUIå·²ç»å­˜åœ¨ï¼Œç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®
            if mainButton then
                mainButton.Text = "æ¼‚æµ®: å…³é—­"
                mainButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            end
            if fixButton then
                fixButton.Text = "é˜²æ­¢æ—‹è½¬: å…³é—­"
                fixButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
            end
            if controlPanel then
                controlPanel.Visible = false
            end
            if openPanelButton then
                openPanelButton.Visible = true
            end
        else
            -- GUIä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
            CreateMobileGUI()
        end

        -- ç­‰å¾…HumanoidåŠ è½½
        local humanoid = character:WaitForChild("Humanoid")

        -- ç›‘å¬æ­»äº¡äº‹ä»¶
        if humanoidDiedConnection then
            humanoidDiedConnection:Disconnect()
        end

        humanoidDiedConnection = humanoid.Died:Connect(function()
            isPlayerDead = true
            print("ç©å®¶æ­»äº¡ï¼Œè‡ªåŠ¨å…³é—­æ¼‚æµ®åŠŸèƒ½")

            -- è‡ªåŠ¨å…³é—­æ¼‚æµ®åŠŸèƒ½ä½†ä¿æŒGUIçŠ¶æ€ä¸å˜
            if anActivity then
                anActivity = false
                CleanupParts()
                -- æ›´æ–°ä¸»æŒ‰é’®çŠ¶æ€
                if mainButton then
                    mainButton.Text = "æ¼‚æµ®: å…³é—­"
                    mainButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
                end
            end

            -- è‡ªåŠ¨å…³é—­é˜²æ­¢æ—‹è½¬æ¨¡å¼
            if _G.fixedMode then
                AllowRotation()
                -- æ›´æ–°é˜²æ­¢æ—‹è½¬æŒ‰é’®çŠ¶æ€
                if fixButton then
                    fixButton.Text = "é˜²æ­¢æ—‹è½¬: å…³é—­"
                    fixButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
                end
            end
        end)
    end

    -- ç›‘å¬è§’è‰²æ·»åŠ äº‹ä»¶
    if characterAddedConnection then
        characterAddedConnection:Disconnect()
    end

    characterAddedConnection = LocalPlayer.CharacterAdded:Connect(onCharacterAdded)

    -- å¦‚æœå·²ç»æœ‰è§’è‰²ï¼Œç«‹å³è®¾ç½®æ£€æµ‹
    if LocalPlayer.Character then
        onCharacterAdded(LocalPlayer.Character)
    end
end

-- æ£€æŸ¥é›¶ä»¶æ˜¯å¦å±äºç©å®¶
local function isPlayerPart(part)
    -- å¦‚æœé›¶ä»¶æœ‰çˆ¶çº§ï¼Œæ£€æŸ¥çˆ¶çº§æ˜¯å¦æ˜¯ç©å®¶è§’è‰²
    if part.Parent then
        -- æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç©å®¶è§’è‰²
        if part.Parent == LocalPlayer.Character then
            return true
        end

        -- æ£€æŸ¥æ˜¯å¦æ˜¯å…¶ä»–ç©å®¶è§’è‰²
        for _, player in ipairs(Players:GetPlayers()) do
            if player.Character and part:IsDescendantOf(player.Character) then
                return true
            end
        end

        -- æ£€æŸ¥æ˜¯å¦åŒ…å«äººä½“éƒ¨ä»¶ï¼ˆHumanoid, Headç­‰ï¼‰
        if part.Parent:FindFirstChild("Humanoid") or part.Parent:FindFirstChild("Head") then
            return true
        end
    end

    return false
end

-- æ ¹æ®è§†è§’è®¡ç®—ç§»åŠ¨æ–¹å‘
local function CalculateMoveDirection()
    -- å¦‚æœç©å®¶æ­»äº¡ï¼Œè¿”å›é›¶å‘é‡
    if isPlayerDead then
        return Vector3.new(0, 0, 0)
    end

    local camera = workspace.CurrentCamera
    if not camera then return Vector3.new(0, 1, 0) end

    if _G.moveDirectionType == "up" then
        return Vector3.new(0, 1, 0)
    elseif _G.moveDirectionType == "down" then
        return Vector3.new(0, -1, 0)
    elseif _G.moveDirectionType == "forward" then
        -- åŸºäºæ‘„åƒæœºçš„å‰æ–¹å‘ï¼ˆå¿½ç•¥Yè½´ï¼‰
        local lookVector = camera.CFrame.LookVector
        return Vector3.new(lookVector.X, 0, lookVector.Z).Unit
    elseif _G.moveDirectionType == "back" then
        -- åŸºäºæ‘„åƒæœºçš„åæ–¹å‘ï¼ˆå¿½ç•¥Yè½´ï¼‰
        local lookVector = camera.CFrame.LookVector
        return -Vector3.new(lookVector.X, 0, lookVector.Z).Unit
    elseif _G.moveDirectionType == "right" then
        -- åŸºäºæ‘„åƒæœºçš„å³æ–¹å‘ï¼ˆå¿½ç•¥Yè½´ï¼‰
        local rightVector = camera.CFrame.RightVector
        return Vector3.new(rightVector.X, 0, rightVector.Z).Unit
    elseif _G.moveDirectionType == "left" then
        -- åŸºäºæ‘„åƒæœºçš„å·¦æ–¹å‘ï¼ˆå¿½ç•¥Yè½´ï¼‰
        local rightVector = camera.CFrame.RightVector
        return -Vector3.new(rightVector.X, 0, rightVector.Z).Unit
    else
        return Vector3.new(0, 1, 0)
    end
end

-- å¤„ç†é›¶ä»¶å‡½æ•°
local function ProcessPart(v)
    -- å¦‚æœç©å®¶æ­»äº¡ï¼Œä¸å¤„ç†ä»»ä½•é›¶ä»¶
    if isPlayerDead then
        return
    end

    -- æ£€æŸ¥é›¶ä»¶æ˜¯å¦å±äºç©å®¶ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡
    if isPlayerPart(v) then
        return
    end

    if v:IsA("Part") and not v.Anchored then
        if _G.processedParts[v] then
            local existingBV = _G.processedParts[v].bodyVelocity
            local existingBG = _G.processedParts[v].bodyGyro
            if existingBV and existingBV.Parent then
                local finalVelocity = CalculateMoveDirection() * _G.floatSpeed
                if existingBV.Velocity ~= finalVelocity then
                    existingBV.Velocity = finalVelocity
                end

                -- æ›´æ–°BodyGyroçŠ¶æ€
                if _G.fixedMode then
                    if not existingBG or not existingBG.Parent then
                        -- åˆ›å»ºBodyGyroæ¥é˜²æ­¢æ—‹è½¬
                        local bodyGyro = Instance.new("BodyGyro")
                        bodyGyro.Parent = v
                        bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
                        bodyGyro.P = 1000
                        bodyGyro.D = 100
                        _G.processedParts[v].bodyGyro = bodyGyro
                    end
                    -- æ¯å¸§æ›´æ–°BodyGyroçš„ç›®æ ‡æœå‘ï¼Œä¿æŒå½“å‰æœå‘
                    if existingBG then
                        existingBG.CFrame = v.CFrame
                    end
                else
                    -- å›ºå®šæ¨¡å¼å…³é—­æ—¶ç§»é™¤BodyGyro
                    if existingBG and existingBG.Parent then
                        existingBG:Destroy()
                        _G.processedParts[v].bodyGyro = nil
                    end
                end
                return
            else
                _G.processedParts[v] = nil
            end
        end

        for _, x in next, v:GetChildren() do
            if x:IsA("BodyAngularVelocity") or x:IsA("BodyForce") or x:IsA("BodyGyro") or 
               x:IsA("BodyPosition") or x:IsA("BodyThrust") or x:IsA("BodyVelocity") then
                x:Destroy()
            end
        end

        if v:FindFirstChild("Torque") then
            v.Torque:Destroy()
        end

        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.Parent = v
        bodyVelocity.Velocity = CalculateMoveDirection() * _G.floatSpeed
        bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)

        -- å¦‚æœå›ºå®šæ¨¡å¼å¼€å¯ï¼Œæ·»åŠ BodyGyroé˜²æ­¢æ—‹è½¬
        local bodyGyro = nil
        if _G.fixedMode then
            bodyGyro = Instance.new("BodyGyro")
            bodyGyro.Parent = v
            bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            bodyGyro.P = 1000
            bodyGyro.D = 100
        end

        _G.processedParts[v] = { 
            bodyVelocity = bodyVelocity, 
            bodyGyro = bodyGyro 
        }
    end
end

local anActivity = false
local updateConnection = nil

local function ProcessAllParts()
    -- å¦‚æœç©å®¶æ­»äº¡ï¼Œä¸å¤„ç†ä»»ä½•é›¶ä»¶
    if isPlayerDead then
        if anActivity then
            anActivity = false
            CleanupParts()
        end
        return
    end

    if anActivity then
        for _, v in next, Workspace:GetDescendants() do
            ProcessPart(v)
        end

        -- å¯åŠ¨æ¯å¸§æ›´æ–°
        if updateConnection then
            updateConnection:Disconnect()
        end

        updateConnection = RunService.Heartbeat:Connect(function()
            UpdateAllPartsVelocity()
        end)
    else
        if updateConnection then
            updateConnection:Disconnect()
            updateConnection = nil
        end
    end
end

Workspace.DescendantAdded:Connect(function(v)
    if anActivity and not isPlayerDead then
        -- æ£€æŸ¥æ–°æ·»åŠ çš„é›¶ä»¶æ˜¯å¦å±äºç©å®¶
        if not isPlayerPart(v) then
            ProcessPart(v)
        end
    end
end)

local function CleanupParts()
    for part, data in pairs(_G.processedParts) do
        if data.bodyVelocity and data.bodyVelocity.Parent then
            data.bodyVelocity:Destroy()
        end
        if data.bodyGyro and data.bodyGyro.Parent then
            data.bodyGyro:Destroy()
        end
    end
    _G.processedParts = {}

    if updateConnection then
        updateConnection:Disconnect()
        updateConnection = nil
    end
end

local function UpdateAllPartsVelocity()
    -- å¦‚æœç©å®¶æ­»äº¡ï¼Œåœæ­¢æ‰€æœ‰ç§»åŠ¨
    if isPlayerDead then
        for part, data in pairs(_G.processedParts) do
            if data.bodyVelocity and data.bodyVelocity.Parent then
                data.bodyVelocity.Velocity = Vector3.new(0, 0, 0)
            end
        end
        return
    end

    local direction = CalculateMoveDirection()
    for part, data in pairs(_G.processedParts) do
        if data.bodyVelocity and data.bodyVelocity.Parent then
            data.bodyVelocity.Velocity = direction * _G.floatSpeed
        end

        -- å¦‚æœå›ºå®šæ¨¡å¼å¼€å¯ï¼Œæ›´æ–°BodyGyroæ¥é˜²æ­¢æ—‹è½¬
        if _G.fixedMode and data.bodyGyro and data.bodyGyro.Parent then
            data.bodyGyro.CFrame = part.CFrame
        end
    end
end

-- åœæ­¢æ‰€æœ‰é›¶ä»¶ç§»åŠ¨
local function StopAllParts()
    _G.floatSpeed = 0
    UpdateAllPartsVelocity()
end

-- é˜²æ­¢ç‰©ä½“æ—‹è½¬
local function PreventRotation()
    _G.fixedMode = true
    -- ä¸ºæ‰€æœ‰å·²å¤„ç†çš„é›¶ä»¶æ·»åŠ BodyGyro
    for part, data in pairs(_G.processedParts) do
        if data.bodyVelocity and data.bodyVelocity.Parent then
            if not data.bodyGyro or not data.bodyGyro.Parent then
                local bodyGyro = Instance.new("BodyGyro")
                bodyGyro.Parent = part
                bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
                bodyGyro.P = 1000
                bodyGyro.D = 100
                data.bodyGyro = bodyGyro
            end
        end
    end
    UpdateAllPartsVelocity()
end

-- å…è®¸ç‰©ä½“æ—‹è½¬
local function AllowRotation()
    _G.fixedMode = false
    -- ç§»é™¤æ‰€æœ‰BodyGyro
    for part, data in pairs(_G.processedParts) do
        if data.bodyGyro and data.bodyGyro.Parent then
            data.bodyGyro:Destroy()
            data.bodyGyro = nil
        end
    end
    UpdateAllPartsVelocity()
end

-- åˆ‡æ¢é˜²æ—‹è½¬æ¨¡å¼
local function ToggleRotationPrevention()
    if _G.fixedMode then
        AllowRotation()
        return false
    else
        PreventRotation()
        return true
    end
end

-- ä½¿GUIå…ƒç´ å¯æ‹–åŠ¨çš„å‡½æ•°
local function MakeDraggable(gui)
    gui.Active = true
    gui.Draggable = true

    local dragHandle = Instance.new("Frame")
    dragHandle.Name = "DragHandle"
    dragHandle.Size = UDim2.new(0, 20, 0, 20)
    dragHandle.Position = UDim2.new(1, -20, 0, 0)
    dragHandle.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
    dragHandle.BorderSizePixel = 0
    dragHandle.Parent = gui

    local gripIcon = Instance.new("TextLabel")
    gripIcon.Name = "GripIcon"
    gripIcon.Size = UDim2.new(1, 0, 1, 0)
    gripIcon.Position = UDim2.new(0, 0, 0, 0)
    gripIcon.Text = "â‰¡"
    gripIcon.TextColor3 = Color3.new(1, 1, 1)
    gripIcon.BackgroundTransparency = 1
    gripIcon.TextSize = 14
    gripIcon.Parent = dragHandle

    dragHandle.Active = true
    dragHandle.Draggable = true
end

-- åˆ›å»ºæ‰‹æœºå‹å¥½çš„GUI
local function CreateMobileGUI()
    print("å¼€å§‹åˆ›å»ºGUI...")

    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MobileFloatingControl"
    screenGui.ResetOnSpawn = false  -- é‡è¦ï¼šé˜²æ­¢é‡ç”Ÿæ—¶GUIæ¶ˆå¤±
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    -- ä¸»å¼€å…³æŒ‰é’® - ç§»åŠ¨åˆ°å³ä¸Šè§’
    mainButton = Instance.new("TextButton")
    mainButton.Name = "MainToggle"
    mainButton.Size = UDim2.new(0, 120, 0, 50)
    mainButton.Position = UDim2.new(1, -130, 0, 10) -- å³ä¸Šè§’ä½ç½®
    mainButton.Text = "æ¼‚æµ®: å…³é—­"
    mainButton.TextSize = 16
    mainButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    mainButton.TextColor3 = Color3.new(1, 1, 1)
    mainButton.Parent = screenGui

    MakeDraggable(mainButton)
    print("ä¸»æŒ‰é’®åˆ›å»ºå®Œæˆ")

    -- æ§åˆ¶é¢æ¿
    controlPanel = Instance.new("Frame")
    controlPanel.Name = "ControlPanel"
    controlPanel.Size = UDim2.new(0, 300, 0, 600) -- å¢åŠ é«˜åº¦ä»¥å®¹çº³æ–°æŒ‰é’®
    controlPanel.Position = UDim2.new(0.5, -150, 0.5, -300)
    controlPanel.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    controlPanel.BackgroundTransparency = 0.3
    controlPanel.BorderSizePixel = 0
    controlPanel.Visible = false
    controlPanel.Parent = screenGui

    MakeDraggable(controlPanel)
    print("æ§åˆ¶é¢æ¿åˆ›å»ºå®Œæˆ")

    -- UIç¼©æ”¾æ§åˆ¶
    local uiScale = Instance.new("UIScale")
    uiScale.Scale = 1.0
    uiScale.Parent = controlPanel

    local scaleLabel = Instance.new("TextLabel")
    scaleLabel.Name = "ScaleLabel"
    scaleLabel.Size = UDim2.new(1, 0, 0, 40)
    scaleLabel.Position = UDim2.new(0, 0, 0, 520)
    scaleLabel.Text = "UIå¤§å°: 1.0"
    scaleLabel.TextColor3 = Color3.new(1, 1, 1)
    scaleLabel.BackgroundTransparency = 1
    scaleLabel.TextSize = 20
    scaleLabel.Parent = controlPanel

    local scaleUpButton = Instance.new("TextButton")
    scaleUpButton.Name = "ScaleUp"
    scaleUpButton.Size = UDim2.new(0, 60, 0, 60)
    scaleUpButton.Position = UDim2.new(0.7, 0, 0, 550)
    scaleUpButton.Text = "+"
    scaleUpButton.TextSize = 30
    scaleUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    scaleUpButton.TextColor3 = Color3.new(1, 1, 1)
    scaleUpButton.Parent = controlPanel

    local scaleDownButton = Instance.new("TextButton")
    scaleDownButton.Name = "ScaleDown"
    scaleDownButton.Size = UDim2.new(0, 60, 0, 60)
    scaleDownButton.Position = UDim2.new(0.3, 0, 0, 550)
    scaleDownButton.Text = "-"
    scaleDownButton.TextSize = 30
    scaleDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    scaleDownButton.TextColor3 = Color3.new(1, 1, 1)
    scaleDownButton.Parent = controlPanel

    -- é€Ÿåº¦æ§åˆ¶
    local speedLabel = Instance.new("TextLabel")
    speedLabel.Name = "SpeedLabel"
    speedLabel.Size = UDim2.new(1, 0, 0, 40)
    speedLabel.Position = UDim2.new(0, 0, 0, 10)
    speedLabel.Text = "é€Ÿåº¦: " .. _G.floatSpeed
    speedLabel.TextColor3 = Color3.new(1, 1, 1)
    speedLabel.BackgroundTransparency = 1
    speedLabel.TextSize = 20
    speedLabel.Parent = controlPanel

    -- é€Ÿåº¦å¢åŠ æŒ‰é’®
    local speedUpButton = Instance.new("TextButton")
    speedUpButton.Name = "SpeedUp"
    speedUpButton.Size = UDim2.new(0, 60, 0, 60)
    speedUpButton.Position = UDim2.new(0.7, 0, 0, 60)
    speedUpButton.Text = "+"
    speedUpButton.TextSize = 30
    speedUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    speedUpButton.TextColor3 = Color3.new(1, 1, 1)
    speedUpButton.Parent = controlPanel

    -- é€Ÿåº¦å‡å°‘æŒ‰é’®
    local speedDownButton = Instance.new("TextButton")
    speedDownButton.Name = "SpeedDown"
    speedDownButton.Size = UDim2.new(0, 60, 0, 60)
    speedDownButton.Position = UDim2.new(0.3, 0, 0, 60)
    speedDownButton.Text = "-"
    speedDownButton.TextSize = 30
    speedDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    speedDownButton.TextColor3 = Color3.new(1, 1, 1)
    speedDownButton.Parent = controlPanel

    -- åœæ­¢æŒ‰é’®
    local stopButton = Instance.new("TextButton")
    stopButton.Name = "Stop"
    stopButton.Size = UDim2.new(0, 100, 0, 40)
    stopButton.Position = UDim2.new(0.5, -50, 0, 130)
    stopButton.Text = "åœæ­¢ç§»åŠ¨"
    stopButton.TextSize = 16
    stopButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
    stopButton.TextColor3 = Color3.new(1, 1, 1)
    stopButton.Parent = controlPanel

    -- é˜²æ­¢æ—‹è½¬æŒ‰é’® - ä¿®å¤ï¼šåˆå§‹çŠ¶æ€ä¸ºå…³é—­
    fixButton = Instance.new("TextButton")
    fixButton.Name = "FixRotation"
    fixButton.Size = UDim2.new(0, 120, 0, 40)
    fixButton.Position = UDim2.new(0.5, -60, 0, 180)
    fixButton.Text = "é˜²æ­¢æ—‹è½¬: å…³é—­"
    fixButton.TextSize = 16
    fixButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100) -- åˆå§‹ä¸ºçº¢è‰²ï¼Œè¡¨ç¤ºå…³é—­
    fixButton.TextColor3 = Color3.new(1, 1, 1)
    fixButton.Parent = controlPanel

    MakeDraggable(fixButton)

    -- æ–¹å‘æ§åˆ¶æ ‡é¢˜
    local directionLabel = Instance.new("TextLabel")
    directionLabel.Name = "DirectionLabel"
    directionLabel.Size = UDim2.new(1, 0, 0, 40)
    directionLabel.Position = UDim2.new(0, 0, 0, 230) -- è°ƒæ•´ä½ç½®
    directionLabel.Text = "ç§»åŠ¨æ–¹å‘ (åŸºäºè§†è§’)"
    directionLabel.TextColor3 = Color3.new(1, 1, 1)
    directionLabel.BackgroundTransparency = 1
    directionLabel.TextSize = 20
    directionLabel.Parent = controlPanel

    -- æ–¹å‘æŒ‰é’®ç½‘æ ¼ - ç°åœ¨åŸºäºè§†è§’æ–¹å‘
    local directions = {
        {name = "å‘ä¸Š", dir = "up", pos = UDim2.new(0.5, -30, 0, 280)},
        {name = "å‘ä¸‹", dir = "down", pos = UDim2.new(0.5, -30, 0, 350)},
        {name = "å‘å‰", dir = "forward", pos = UDim2.new(0.2, -30, 0, 315)},
        {name = "å‘å", dir = "back", pos = UDim2.new(0.8, -30, 0, 315)},
        {name = "å‘å·¦", dir = "left", pos = UDim2.new(0.05, -30, 0, 315)},
        {name = "å‘å³", dir = "right", pos = UDim2.new(0.95, -30, 0, 315)}
    }

    for i, dirInfo in ipairs(directions) do
        local button = Instance.new("TextButton")
        button.Name = dirInfo.name
        button.Size = UDim2.new(0, 60, 0, 60)
        button.Position = dirInfo.pos
        button.Text = dirInfo.name
        button.TextSize = 14
        button.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
        button.TextColor3 = Color3.new(1, 1, 1)
        button.Parent = controlPanel

        button.MouseButton1Click:Connect(function()
            -- å¦‚æœç©å®¶æ­»äº¡ï¼Œä¸å…è®¸æ›´æ”¹æ–¹å‘
            if isPlayerDead then
                local warningMsg = Instance.new("Message")
                warningMsg.Text = "æ­»äº¡çŠ¶æ€ä¸‹æ— æ³•æ›´æ”¹æ–¹å‘ï¼"
                warningMsg.Parent = Workspace
                delay(2, function()
                    warningMsg:Destroy()
                end)
                return
            end

            _G.moveDirectionType = dirInfo.dir
            UpdateAllPartsVelocity()

            local originalColor = button.BackgroundColor3
            button.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
            delay(0.2, function()
                button.BackgroundColor3 = originalColor
            end)
        end)
    end

    -- å…³é—­é¢æ¿æŒ‰é’®
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "ClosePanel"
    closeButton.Size = UDim2.new(0, 100, 0, 40)
    closeButton.Position = UDim2.new(0.5, -50, 0, 430) -- è°ƒæ•´ä½ç½®
    closeButton.Text = "å…³é—­é¢æ¿"
    closeButton.TextSize = 16
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
    closeButton.TextColor3 = Color3.new(1, 1, 1)
    closeButton.Parent = controlPanel

    -- é€Ÿåº¦æŒ‰é’®åŠŸèƒ½
    speedUpButton.MouseButton1Click:Connect(function()
        -- å¦‚æœç©å®¶æ­»äº¡ï¼Œä¸å…è®¸æ›´æ”¹é€Ÿåº¦
        if isPlayerDead then
            local warningMsg = Instance.new("Message")
            warningMsg.Text = "æ­»äº¡çŠ¶æ€ä¸‹æ— æ³•æ›´æ”¹é€Ÿåº¦ï¼"
            warningMsg.Parent = Workspace
            delay(2, function()
                warningMsg:Destroy()
            end)
            return
        end

        _G.floatSpeed = math.clamp(_G.floatSpeed + 5, 1, 10000) -- æœ€å¤§é€Ÿåº¦å¢åŠ åˆ°10000
        speedLabel.Text = "é€Ÿåº¦: " .. _G.floatSpeed
        UpdateAllPartsVelocity()

        local originalColor = speedUpButton.BackgroundColor3
        speedUpButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        delay(0.2, function()
            speedUpButton.BackgroundColor3 = originalColor
        end)
    end)

    -- ä¿®å¤å‡é€Ÿåº¦æŒ‰é’®çš„bug
    speedDownButton.MouseButton1Click:Connect(function()
        -- å¦‚æœç©å®¶æ­»äº¡ï¼Œä¸å…è®¸æ›´æ”¹é€Ÿåº¦
        if isPlayerDead then
            local warningMsg = Instance.new("Message")
            warningMsg.Text = "æ­»äº¡çŠ¶æ€ä¸‹æ— æ³•æ›´æ”¹é€Ÿåº¦ï¼"
            warningMsg.Parent = Workspace
            delay(2, function()
                warningMsg:Destroy()
            end)
            return
        end

        _G.floatSpeed = math.clamp(_G.floatSpeed - 5, 1, 10000) -- æœ€å¤§é€Ÿåº¦å¢åŠ åˆ°10000
        speedLabel.Text = "é€Ÿåº¦: " .. _G.floatSpeed
        UpdateAllPartsVelocity()

        local originalColor = speedDownButton.BackgroundColor3
        speedDownButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        delay(0.2, function()
            speedDownButton.BackgroundColor3 = originalColor
        end)
    end)

    -- åœæ­¢æŒ‰é’®åŠŸèƒ½
    stopButton.MouseButton1Click:Connect(function()
        -- å¦‚æœç©å®¶æ­»äº¡ï¼Œä¸å…è®¸æ“ä½œ
        if isPlayerDead then
            local warningMsg = Instance.new("Message")
            warningMsg.Text = "æ­»äº¡çŠ¶æ€ä¸‹æ— æ³•æ“ä½œï¼"
            warningMsg.Parent = Workspace
            delay(2, function()
                warningMsg:Destroy()
            end)
            return
        end

        StopAllParts()
        speedLabel.Text = "é€Ÿåº¦: " .. _G.floatSpeed

        local originalColor = stopButton.BackgroundColor3
        stopButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        delay(0.2, function()
            stopButton.BackgroundColor3 = originalColor
        end)
    end)

    -- é˜²æ­¢æ—‹è½¬æŒ‰é’®åŠŸèƒ½ - ä¿®å¤ï¼šåªåœ¨ç‚¹å‡»æ—¶åˆ‡æ¢ï¼Œåˆå§‹çŠ¶æ€ä¸ºå…³é—­
    fixButton.MouseButton1Click:Connect(function()
        -- å¦‚æœç©å®¶æ­»äº¡ï¼Œä¸å…è®¸æ“ä½œ
        if isPlayerDead then
            local warningMsg = Instance.new("Message")
            warningMsg.Text = "æ­»äº¡çŠ¶æ€ä¸‹æ— æ³•æ“ä½œï¼"
            warningMsg.Parent = Workspace
            delay(2, function()
                warningMsg:Destroy()
            end)
            return
        end

        -- åˆ‡æ¢é˜²æ­¢æ—‹è½¬çŠ¶æ€
        local newFixedState = ToggleRotationPrevention()

        -- æ›´æ–°UI
        if newFixedState then
            fixButton.Text = "é˜²æ­¢æ—‹è½¬: å¼€å¯"
            fixButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
            print("é˜²æ—‹è½¬æ¨¡å¼å·²å¼€å¯")
        else
            fixButton.Text = "é˜²æ­¢æ—‹è½¬: å…³é—­"
            fixButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
            print("é˜²æ—‹è½¬æ¨¡å¼å·²å…³é—­")
        end

        local originalColor = fixButton.BackgroundColor3
        fixButton.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
        delay(0.2, function()
            fixButton.BackgroundColor3 = originalColor
        end)
    end)

    -- æ‰“å¼€é¢æ¿æŒ‰é’® - ç§»åŠ¨åˆ°å³ä¸Šè§’ï¼Œåœ¨ä¸»æŒ‰é’®ä¸‹æ–¹
    openPanelButton = Instance.new("TextButton")
    openPanelButton.Name = "OpenPanel"
    openPanelButton.Size = UDim2.new(0, 120, 0, 40)
    openPanelButton.Position = UDim2.new(1, -130, 0, 70) -- å³ä¸Šè§’ä½ç½®ï¼Œåœ¨ä¸»æŒ‰é’®ä¸‹æ–¹
    openPanelButton.Text = "æ‰“å¼€æ§åˆ¶é¢æ¿"
    openPanelButton.TextSize = 14
    openPanelButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    openPanelButton.TextColor3 = Color3.new(1, 1, 1)
    openPanelButton.Visible = true  -- åˆå§‹çŠ¶æ€ä¸ºå¯è§
    openPanelButton.Parent = screenGui

    MakeDraggable(openPanelButton)

    -- ä¸»å¼€å…³åŠŸèƒ½ - ä¿®å¤æ­»äº¡åæ— æ³•æ“ä½œçš„é—®é¢˜
    mainButton.MouseButton1Click:Connect(function()
        -- æ­»äº¡æ—¶ä¹Ÿå…è®¸å…³é—­æ¼‚æµ®åŠŸèƒ½
        if isPlayerDead and anActivity then
            -- æ­»äº¡æ—¶å…è®¸å¼ºåˆ¶å…³é—­
            anActivity = false
            CleanupParts()
            mainButton.Text = "æ¼‚æµ®: å…³é—­"
            mainButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            print("æ­»äº¡çŠ¶æ€ä¸‹å¼ºåˆ¶å…³é—­æ¼‚æµ®åŠŸèƒ½")
            return
        end

        -- å¦‚æœç©å®¶æ­»äº¡ä¸”å°è¯•å¼€å¯ï¼Œåˆ™æ‹’ç»
        if isPlayerDead and not anActivity then
            local warningMsg = Instance.new("Message")
            warningMsg.Text = "æ­»äº¡çŠ¶æ€ä¸‹æ— æ³•å¼€å¯æ¼‚æµ®ï¼"
            warningMsg.Parent = Workspace
            delay(2, function()
                warningMsg:Destroy()
            end)
            return
        end

        anActivity = not anActivity
        ProcessAllParts()
        if anActivity then
            mainButton.Text = "æ¼‚æµ®: å¼€å¯"
            mainButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            UpdateAllPartsVelocity()
            print("æ¼‚æµ®åŠŸèƒ½å·²å¼€å¯")
        else
            CleanupParts()
            mainButton.Text = "æ¼‚æµ®: å…³é—­"
            mainButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            print("æ¼‚æµ®åŠŸèƒ½å·²å…³é—­")
        end
    end)

    -- å…³é—­é¢æ¿åŠŸèƒ½
    closeButton.MouseButton1Click:Connect(function()
        controlPanel.Visible = false
        openPanelButton.Visible = true
        print("æ§åˆ¶é¢æ¿å·²å…³é—­")
    end)

    -- æ‰“å¼€é¢æ¿åŠŸèƒ½
    openPanelButton.MouseButton1Click:Connect(function()
        controlPanel.Visible = true
        openPanelButton.Visible = false
        print("æ§åˆ¶é¢æ¿å·²æ‰“å¼€")
    end)

    -- UIç¼©æ”¾åŠŸèƒ½
    scaleUpButton.MouseButton1Click:Connect(function()
        uiScale.Scale = math.min(uiScale.Scale + 0.1, 1.5)
        scaleLabel.Text = "UIå¤§å°: " .. string.format("%.1f", uiScale.Scale)
        local originalColor = scaleUpButton.BackgroundColor3
        scaleUpButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        delay(0.2, function()
            scaleUpButton.BackgroundColor3 = originalColor
        end)
    end)

    scaleDownButton.MouseButton1Click:Connect(function()
        uiScale.Scale = math.max(uiScale.Scale - 0.1, 0.5)
        scaleLabel.Text = "UIå¤§å°: " .. string.format("%.1f", uiScale.Scale)
        local originalColor = scaleDownButton.BackgroundColor3
        scaleDownButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        delay(0.2, function()
            scaleDownButton.BackgroundColor3 = originalColor
        end)
    end)

    print("GUIåˆ›å»ºå®Œæˆ")
    return screenGui
end

-- æ·»åŠ é”™è¯¯å¤„ç†
local success, err = pcall(function()
    CreateMobileGUI()
    -- è®¾ç½®æ­»äº¡æ£€æµ‹å’Œè‡ªåŠ¨é‡è¿
    setupDeathDetectionAndReconnect()
end)

if not success then
    warn("GUIåˆ›å»ºå¤±è´¥: " .. tostring(err))

    -- æ˜¾ç¤ºä¸ª78çš„é”™è¯¯ä¿¡æ¯
    local errorMsg = Instance.new("Message")
    errorMsg.Parent = Workspace
    delay(5, function()
        errorMsg:Destroy()
    end)
end
