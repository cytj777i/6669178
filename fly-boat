local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- ç­‰å¾…æ¸¸æˆåŠ è½½å®Œæˆ
if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- æ˜¾ç¤ºä½œè€…ä¿¡æ¯
local authorMessage = Instance.new("Message")
authorMessage.Text = "æ­¤è„šæœ¬ä¸ºå…è´¹è„šæœ¬ï¼Œè¢«å€’å–éª—äº†ï¼Œæˆ‘ä¸è´Ÿè´£ğŸ¤«\nå…³äºæ§åˆ¶æœªå›ºå®šé›¶ä»¶çš„è„šæœ¬æˆ‘æäº†ä¸‰ä¸ªï¼Œè¿™æ˜¯ç¬¬3ä¸ªç‰ˆæœ¬\nåˆ¶ä½œçµæ„Ÿæ¥æºäºåé‡åŠ›çŠ¶æ€è„šæœ¬\nåªèƒ½æ§åˆ¶æœªå›ºå®šé›¶ä»¶ï¼Œè§£é™¤å›ºå®šä¹Ÿæ˜¯åªèƒ½è§£é™¤ä½ å›ºå®šçš„é›¶ä»¶\né£èˆ¹æ¨¡å¼å°±æ˜¯æŠŠä½ å›ºå®šçš„é›¶ä»¶é›†ä½“æ§åˆ¶å¯è½½äººé£è¡Œé‚£ç§\n12/8ä¿®å¤äº†é£èˆ¹æ¨¡å¼ä¸‹ä¸å¥½æ§åˆ¶çš„é—®é¢˜\nä½œè€…ciTiy"
authorMessage.Parent = Workspace
delay(5, function()
    authorMessage:Destroy()
end)

-- ç­‰å¾…æœ¬åœ°ç©å®¶åŠ è½½
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    LocalPlayer = Players.LocalPlayer
end

-- å…¨å±€å˜é‡
_G.selectedPart = nil
_G.selectedHighlight = nil
_G.floatSpeed = 20 -- å¢åŠ è·Ÿéšé€Ÿåº¦
_G.followDistance = 20
_G.isFollowing = false
_G.rotationSpeed = 0.5
_G.flipAngle = 15 -- æ¯æ¬¡ç¿»è½¬çš„è§’åº¦ï¼ˆåº¦ï¼‰
_G.isFixed = false -- æ ‡è®°å½“å‰é€‰æ‹©çš„ç‰©ä½“æ˜¯å¦è¢«å›ºå®š
_G.fixedParts = {} -- æ–°å¢ï¼šå­˜å‚¨æ‰€æœ‰è¢«å›ºå®šçš„ç‰©ä½“
_G.followConnection = nil -- æ–°å¢ï¼šè·Ÿéšè¿æ¥çš„å¼•ç”¨
_G.spaceshipMode = false -- é£èˆ¹æ¨¡å¼çŠ¶æ€
_G.spaceshipSpeed = 20 -- é£èˆ¹æ¨¡å¼ç§»åŠ¨é€Ÿåº¦
_G.spaceshipVelocities = {} -- æ–°å¢ï¼šå­˜å‚¨é£èˆ¹æ¨¡å¼ä¸­ç‰©ä½“çš„é€Ÿåº¦
_G.spaceshipGyros = {} -- æ–°å¢ï¼šå­˜å‚¨é£èˆ¹æ¨¡å¼ä¸­ç‰©ä½“çš„é™€èºä»ª
_G.followVelocity = nil -- æ–°å¢ï¼šè·Ÿéšæ¨¡å¼çš„é€Ÿåº¦æ§åˆ¶å™¨
_G.followGyro = nil -- æ–°å¢ï¼šè·Ÿéšæ¨¡å¼çš„é™€èºä»ª

-- æ–°å¢ï¼šç¿»è½¬æ§åˆ¶å˜é‡
_G.flipX = 0
_G.flipY = 0
_G.flipZ = 0
_G.rotationSpeed = 1

-- æ–°å¢ï¼šç¿»è½¬çŠ¶æ€è·Ÿè¸ª
_G.activeFlips = {} -- è·Ÿè¸ªæ­£åœ¨è¿›è¡Œçš„ç¿»è½¬
_G.flipAngularVelocities = {} -- å­˜å‚¨è§’é€Ÿåº¦å¯¹è±¡

-- æ–°å¢ï¼šé£èˆ¹æ¨¡å¼ç§»åŠ¨æ–¹å‘è·Ÿè¸ª
_G.currentMoveDirection = nil -- å½“å‰ç§»åŠ¨æ–¹å‘

-- è®¾ç½®æ¨¡æ‹ŸåŠå¾„
local function setupSimulationRadius()
    local success, err = pcall(function()
        RunService.Heartbeat:Connect(function()
            pcall(function()
                sethiddenproperty(LocalPlayer, "SimulationRadius", math.huge)
                sethiddenproperty(LocalPlayer, "MaxSimulationRadius", math.huge)
            end)
        end)
    end)

    if not success then
        warn("æ¨¡æ‹ŸåŠå¾„è®¾ç½®å¤±è´¥: " .. tostring(err))
    end
end

setupSimulationRadius()

-- è§’è‰²æ­»äº¡è‡ªåŠ¨é‡è¿åŠŸèƒ½
local function setupAutoReconnect()
    LocalPlayer.CharacterAdded:Connect(function(character)
        character:WaitForChild("Humanoid")
        setupSimulationRadius()
        print("è§’è‰²å·²é‡ç”Ÿï¼Œæ¼‚æµ®æ§åˆ¶è„šæœ¬å·²è‡ªåŠ¨é‡æ–°è¿æ¥")

        -- é‡ç”Ÿåé‡ç½®è·ŸéšçŠ¶æ€ï¼Œä½†ä¿æŒå›ºå®šçŠ¶æ€
        if _G.selectedPart then
            _G.isFollowing = false
            if not _G.isFixed then
                StopPart()
                removeHighlight()
                _G.selectedPart = nil
            end
        end
    end)

    LocalPlayer.CharacterRemoving:Connect(function()
        if _G.selectedPart then
            -- å¦‚æœæ˜¯å›ºå®šçŠ¶æ€ï¼Œä¿æŒå›ºå®šï¼Œåªç§»é™¤é«˜äº®
            if _G.isFixed then
                removeHighlight()
            else
                -- å¦‚æœæ˜¯è·ŸéšçŠ¶æ€ï¼Œå®Œå…¨åœæ­¢å¹¶æ¸…é™¤
                pcall(function()
                    StopPart()
                    removeHighlight()
                end)
                _G.selectedPart = nil
                _G.isFollowing = false
            end
        end
    end)
end

setupAutoReconnect()

-- åˆ›å»ºé«˜äº®æ•ˆæœ
local function createHighlight(part)
    if _G.selectedHighlight then
        _G.selectedHighlight:Destroy()
        _G.selectedHighlight = nil
    end

    local highlight = Instance.new("SelectionBox")
    highlight.Name = "FloatingHighlight"
    highlight.Adornee = part
    highlight.Color3 = Color3.fromRGB(0, 0, 255)
    highlight.LineThickness = 0.05
    highlight.Parent = part

    _G.selectedHighlight = highlight
    return highlight
end

-- ç§»é™¤é«˜äº®æ•ˆæœ
local function removeHighlight()
    if _G.selectedHighlight then
        _G.selectedHighlight:Destroy()
        _G.selectedHighlight = nil
    end
end

-- åœæ­¢é›¶ä»¶ç§»åŠ¨å’Œç¿»è½¬
local function StopPart()
    if _G.selectedPart then
        for _, child in ipairs(_G.selectedPart:GetChildren()) do
            if child:IsA("BodyVelocity") or child:IsA("BodyAngularVelocity") or 
               child:IsA("BodyPosition") or child:IsA("BodyGyro") then
                child:Destroy()
            end
        end
    end
    -- æ–­å¼€è·Ÿéšè¿æ¥
    if _G.followConnection then
        _G.followConnection:Disconnect()
        _G.followConnection = nil
    end
    -- æ¸…ç†è·Ÿéšæ¨¡å¼çš„æ§åˆ¶å™¨
    if _G.followVelocity then
        _G.followVelocity:Destroy()
        _G.followVelocity = nil
    end
    if _G.followGyro then
        _G.followGyro:Destroy()
        _G.followGyro = nil
    end

    -- åœæ­¢æ‰€æœ‰ç¿»è½¬
    for part, _ in pairs(_G.activeFlips) do
        _G.activeFlips[part] = nil
        if _G.flipAngularVelocities[part] then
            _G.flipAngularVelocities[part]:Destroy()
            _G.flipAngularVelocities[part] = nil
        end
    end
end

-- è·Ÿéšè§†è§’åŠŸèƒ½ - ä¿®æ”¹ä¸ºä½¿ç”¨BodyVelocityå®ç°ç±»ä¼¼é£èˆ¹æ¨¡å¼çš„é£è¡Œ
local function FollowCamera()
    if not _G.selectedPart or not _G.isFollowing or _G.isFixed then return end

    StopPart() -- æ¸…é™¤æ—§çš„èº«ä½“åŠ›

    local camera = Workspace.CurrentCamera
    if not camera then return end

    -- å–æ¶ˆå›ºå®šçŠ¶æ€ï¼Œè®©ç‰©ä½“å¯ä»¥ç§»åŠ¨
    _G.selectedPart.Anchored = false

    -- ä½¿ç”¨BodyVelocityå’ŒBodyGyroçš„ç»„åˆæ¥å®ç°å¹³æ»‘è·Ÿéšï¼ˆç±»ä¼¼é£èˆ¹æ¨¡å¼ï¼‰
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.Parent = _G.selectedPart
    _G.followVelocity = bodyVelocity

    local bodyGyro = Instance.new("BodyGyro")
    bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    bodyGyro.P = 1000
    bodyGyro.D = 500
    bodyGyro.CFrame = _G.selectedPart.CFrame  -- ä¿æŒå½“å‰æ–¹å‘
    bodyGyro.Parent = _G.selectedPart
    _G.followGyro = bodyGyro

    -- æ¯å¸§æ›´æ–°ä½ç½®å’Œæ—‹è½¬
    _G.followConnection = RunService.Heartbeat:Connect(function()
        if not _G.selectedPart or not _G.isFollowing or _G.isFixed then
            if _G.followConnection then
                _G.followConnection:Disconnect()
                _G.followConnection = nil
            end
            return
        end

        local cameraCFrame = camera.CFrame
        local lookVector = cameraCFrame.LookVector

        -- æ­£ç¡®è®¡ç®—ç›®æ ‡ä½ç½®ï¼Œè€ƒè™‘Yè½´é«˜åº¦
        local targetPosition = cameraCFrame.Position + (lookVector * _G.followDistance)

        -- è®¡ç®—ä»å½“å‰ä½ç½®åˆ°ç›®æ ‡ä½ç½®çš„æ–¹å‘
        local direction = (targetPosition - _G.selectedPart.Position)

        -- å¦‚æœè·ç¦»è¾ƒè¿œï¼Œä½¿ç”¨æœ€å¤§é€Ÿåº¦ï¼›å¦‚æœæ¥è¿‘ç›®æ ‡ï¼Œå‡é€Ÿ
        local distance = direction.Magnitude
        local speedMultiplier = math.min(1, distance / 5) -- è·ç¦»5ä»¥å†…å¼€å§‹å‡é€Ÿ

        -- è®¾ç½®é€Ÿåº¦å‘é‡
        if distance > 0.5 then
            bodyVelocity.Velocity = direction.Unit * _G.floatSpeed * speedMultiplier
        else
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end

        -- ä¿æŒç‰©ä½“å½“å‰çš„æ–¹å‘ï¼Œä¸å¼ºåˆ¶æœå‘æ‘„åƒæœº
        bodyGyro.CFrame = _G.selectedPart.CFrame
    end)
end

-- å›ºå®šé›¶ä»¶åœ¨å½“å‰ä½ç½®
local function FixPart()
    if _G.selectedPart and not _G.isFixed then
        StopPart() -- åœæ­¢æ‰€æœ‰è¿åŠ¨

        -- è®¾ç½®é›¶ä»¶ä¸ºå›ºå®šçŠ¶æ€ï¼Œä½¿å…¶å®Œå…¨é™æ­¢
        _G.selectedPart.Anchored = true

        -- æ ‡è®°ä¸ºå·²å›ºå®šå¹¶æ·»åŠ åˆ°å›ºå®šåˆ—è¡¨
        _G.isFixed = true
        _G.fixedParts[_G.selectedPart] = true

        return true
    end
    return false
end

-- è§£é™¤å›ºå®š
local function UnfixPart()
    if _G.selectedPart and _G.isFixed then
        -- å–æ¶ˆå›ºå®šçŠ¶æ€
        _G.selectedPart.Anchored = false
        _G.isFixed = false
        _G.fixedParts[_G.selectedPart] = nil

        -- é‡æ–°å¼€å§‹è·Ÿéš
        _G.isFollowing = true
        FollowCamera()

        -- é‡æ–°æ·»åŠ é«˜äº®
        createHighlight(_G.selectedPart)

        return true
    end
    return false
end

-- æ£€æŸ¥é›¶ä»¶æ˜¯å¦å¯æ§åˆ¶
local function IsPartControllable(part)
    -- å…è®¸é€‰æ‹©ä»»ä½•é›¶ä»¶ï¼ŒåŒ…æ‹¬å·²å›ºå®šçš„å’Œæœªå›ºå®šçš„
    return part:IsA("Part") and not part.Parent:FindFirstChild("Humanoid") and 
           not part.Parent:FindFirstChild("Head") and part.Parent ~= LocalPlayer.Character
end

-- é€‰æ‹©é›¶ä»¶å‡½æ•° - ä¿®æ”¹ï¼šæ”¯æŒé‡å¤ç‚¹å‡»å–æ¶ˆé€‰æ‹©ï¼Œä½†ä¸ä¼šå–æ¶ˆå›ºå®šçŠ¶æ€
local function SelectPart(part)
    if IsPartControllable(part) then
        -- å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰æ‹©çš„é›¶ä»¶ï¼ˆæ— è®ºæ˜¯å¦å›ºå®šï¼‰ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
        if _G.selectedPart == part then
            -- åœæ­¢è¯¥é›¶ä»¶çš„æ‰€æœ‰è¿åŠ¨ï¼ˆå¦‚æœæ˜¯è·ŸéšçŠ¶æ€ï¼‰
            if not _G.isFixed then
                StopPart()
                _G.isFollowing = false
            end
            -- ç§»é™¤é«˜äº®
            removeHighlight()
            -- å–æ¶ˆé€‰æ‹©
            _G.selectedPart = nil
            _G.isFixed = false
            return true
        end

        -- å¦‚æœé›¶ä»¶æ˜¯å·²å›ºå®šçš„ï¼Œä½†ä¸åœ¨å½“å‰é€‰æ‹©ä¸­ï¼Œåˆ™é€‰æ‹©å®ƒä½†ä¸å¼€å§‹è·Ÿéš
        if _G.fixedParts[part] then
            -- å–æ¶ˆä¹‹å‰çš„é€‰æ‹©
            if _G.selectedPart then
                if not _G.fixedParts[_G.selectedPart] then
                    StopPart()
                    _G.isFollowing = false
                end
                removeHighlight()
            end

            -- é€‰æ‹©æ–°é›¶ä»¶
            _G.selectedPart = part
            _G.isFixed = true
            _G.isFollowing = false

            -- æ·»åŠ é«˜äº®
            createHighlight(part)
            return true
        end

        -- é€‰æ‹©æ–°é›¶ä»¶ï¼ˆæœªå›ºå®šçš„ï¼‰
        -- å–æ¶ˆä¹‹å‰çš„é€‰æ‹©
        if _G.selectedPart then
            if not _G.fixedParts[_G.selectedPart] then
                StopPart()
                _G.isFollowing = false
            end
            removeHighlight()
        end

        -- é€‰æ‹©æ–°é›¶ä»¶
        _G.selectedPart = part
        _G.isFixed = false
        _G.isFollowing = true

        -- æ·»åŠ é«˜äº®å¹¶å¼€å§‹è·Ÿéš
        createHighlight(part)
        FollowCamera()

        return true
    end
    return false
end

-- å°„çº¿æ£€æµ‹å‡½æ•°
local function getTargetPart()
    local camera = Workspace.CurrentCamera
    local mousePos = UserInputService:GetMouseLocation()
    local unitRay = camera:ViewportPointToRay(mousePos.X, mousePos.Y)
    local ray = Ray.new(unitRay.Origin, unitRay.Direction * 1000)

    local part, position = Workspace:FindPartOnRay(ray, LocalPlayer.Character)
    return part
end

-- åº”ç”¨ç¿»è½¬ - ä¿®æ”¹ä¸ºä½¿ç”¨BodyAngularVelocityå®ç°æŒç»­ç¿»è½¬ï¼Œä½†æ·»åŠ è‡ªåŠ¨åœæ­¢åŠŸèƒ½
local function ApplyFlip(axis, angleDegrees)
    if _G.selectedPart and not _G.isFixed then
        -- åœæ­¢è¯¥é›¶ä»¶ä¸Šå¯èƒ½æ­£åœ¨è¿›è¡Œçš„ç¿»è½¬
        if _G.activeFlips[_G.selectedPart] then
            if _G.flipAngularVelocities[_G.selectedPart] then
                _G.flipAngularVelocities[_G.selectedPart]:Destroy()
                _G.flipAngularVelocities[_G.selectedPart] = nil
            end
            _G.activeFlips[_G.selectedPart] = nil
        end

        -- æ¸…é™¤æ—§çš„è§’é€Ÿåº¦
        for _, child in ipairs(_G.selectedPart:GetChildren()) do
            if child:IsA("BodyAngularVelocity") then
                child:Destroy()
            end
        end

        -- è®¡ç®—è§’é€Ÿåº¦ï¼ˆå¼§åº¦/ç§’ï¼‰
        local angleRadians = math.rad(angleDegrees) * _G.rotationSpeed

        -- æ ¹æ®è½´è®¾ç½®è§’é€Ÿåº¦
        local angularVelocity = Vector3.new(0, 0, 0)
        if axis == "X" then
            angularVelocity = Vector3.new(angleRadians, 0, 0)
        elseif axis == "Y" then
            angularVelocity = Vector3.new(0, angleRadians, 0)
        elseif axis == "Z" then
            angularVelocity = Vector3.new(0, 0, angleRadians)
        end

        -- æ·»åŠ è§’é€Ÿåº¦ä»¥å®ç°ç¿»è½¬
        local bodyAngularVelocity = Instance.new("BodyAngularVelocity")
        bodyAngularVelocity.AngularVelocity = angularVelocity
        bodyAngularVelocity.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
        bodyAngularVelocity.Parent = _G.selectedPart

        _G.flipAngularVelocities[_G.selectedPart] = bodyAngularVelocity
        _G.activeFlips[_G.selectedPart] = {
            axis = axis,
            targetAngle = math.rad(angleDegrees),
            currentAngle = 0,
            startTime = tick(),
            angularVelocity = bodyAngularVelocity
        }
    end
end

-- è·å–åŸºäºè§†è§’çš„æ–¹å‘ï¼ˆå‚è€ƒç¬¬äºŒä¸ªè„šæœ¬ï¼‰
local function getCameraRelativeDirection(direction)
    local camera = Workspace.CurrentCamera
    if not camera then return direction end

    local cameraCFrame = camera.CFrame
    local relativeDirection = Vector3.new(0, 0, 0)

    -- å°†ä¸–ç•Œåæ ‡ç³»çš„æ–¹å‘è½¬æ¢ä¸ºåŸºäºè§†è§’çš„æ–¹å‘
    if direction == Vector3.new(0, 0, 1) then -- å‰
        relativeDirection = cameraCFrame.LookVector
        relativeDirection = Vector3.new(relativeDirection.X, 0, relativeDirection.Z).Unit
    elseif direction == Vector3.new(0, 0, -1) then -- å
        relativeDirection = -cameraCFrame.LookVector
        relativeDirection = Vector3.new(relativeDirection.X, 0, relativeDirection.Z).Unit
    elseif direction == Vector3.new(-1, 0, 0) then -- å·¦
        relativeDirection = -cameraCFrame.RightVector
        relativeDirection = Vector3.new(relativeDirection.X, 0, relativeDirection.Z).Unit
    elseif direction == Vector3.new(1, 0, 0) then -- å³
        relativeDirection = cameraCFrame.RightVector
        relativeDirection = Vector3.new(relativeDirection.X, 0, relativeDirection.Z).Unit
    else
        -- ä¸Šä¸‹æ–¹å‘ä¿æŒä¸å˜
        relativeDirection = direction
    end

    return relativeDirection
end

-- é£èˆ¹æ¨¡å¼ç§»åŠ¨å‡½æ•° - ä¿®å¤ï¼šåŸºäºè§†è§’çš„æ–¹å‘æ§åˆ¶
local function MoveSpaceship(direction)
    if not _G.spaceshipMode then return end

    local camera = Workspace.CurrentCamera
    if not camera then return end

    local moveVector = Vector3.new(0, 0, 0)
    local cameraCFrame = camera.CFrame

    -- è·å–åŸºäºè§†è§’çš„æ–¹å‘
    if direction == "forward" then
        -- å‰ï¼šæ²¿æ‘„åƒæœºçœ‹å‘çš„æ–¹å‘ï¼Œä½†å¿½ç•¥Yè½´ï¼ˆæ°´å¹³å‘å‰ï¼‰
        moveVector = cameraCFrame.LookVector
        moveVector = Vector3.new(moveVector.X, 0, moveVector.Z).Unit * _G.spaceshipSpeed
    elseif direction == "backward" then
        -- åï¼šä¸å‘å‰ç›¸å
        moveVector = -cameraCFrame.LookVector
        moveVector = Vector3.new(moveVector.X, 0, moveVector.Z).Unit * _G.spaceshipSpeed
    elseif direction == "left" then
        -- å·¦ï¼šæ²¿æ‘„åƒæœºå³ä¾§å‘é‡çš„åæ–¹å‘ï¼ˆå³å·¦ä¾§ï¼‰
        moveVector = -cameraCFrame.RightVector
        moveVector = Vector3.new(moveVector.X, 0, moveVector.Z).Unit * _G.spaceshipSpeed
    elseif direction == "right" then
        -- å³ï¼šæ²¿æ‘„åƒæœºå³ä¾§å‘é‡
        moveVector = cameraCFrame.RightVector
        moveVector = Vector3.new(moveVector.X, 0, moveVector.Z).Unit * _G.spaceshipSpeed
    elseif direction == "up" then
        -- ä¸Šï¼šä¸–ç•Œåæ ‡ç³»Yè½´æ­£æ–¹å‘
        moveVector = Vector3.new(0, _G.spaceshipSpeed, 0)
    elseif direction == "down" then
        -- ä¸‹ï¼šä¸–ç•Œåæ ‡ç³»Yè½´è´Ÿæ–¹å‘
        moveVector = Vector3.new(0, -_G.spaceshipSpeed, 0)
    end

    -- è®°å½•å½“å‰ç§»åŠ¨æ–¹å‘
    _G.currentMoveDirection = direction

    -- å¯¹æ¯ä¸ªå›ºå®šç‰©ä½“åº”ç”¨ç§»åŠ¨
    for part, _ in pairs(_G.fixedParts) do
        if part and part.Parent then
            -- å–æ¶ˆå›ºå®šçŠ¶æ€ï¼Œè®©ç‰©ä½“å¯ä»¥ç§»åŠ¨
            part.Anchored = false

            -- æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰BodyVelocityï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
            if not _G.spaceshipVelocities[part] then
                local bodyVelocity = Instance.new("BodyVelocity")
                bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                bodyVelocity.Parent = part
                _G.spaceshipVelocities[part] = bodyVelocity
            end

            -- æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰BodyGyroï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºï¼ˆé˜²æ­¢æ—‹è½¬ï¼‰
            if not _G.spaceshipGyros[part] then
                local bodyGyro = Instance.new("BodyGyro")
                bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
                bodyGyro.P = 1000
                bodyGyro.D = 500
                bodyGyro.CFrame = part.CFrame  -- ä¿æŒå½“å‰æ–¹å‘
                bodyGyro.Parent = part
                _G.spaceshipGyros[part] = bodyGyro
            end

            -- è®¾ç½®é€Ÿåº¦
            _G.spaceshipVelocities[part].Velocity = moveVector

            -- ä¿æŒé™€èºä»ªæ–¹å‘
            if _G.spaceshipGyros[part] then
                _G.spaceshipGyros[part].CFrame = part.CFrame
            end
        end
    end
end

-- åœæ­¢é£èˆ¹æ¨¡å¼ç§»åŠ¨
local function StopSpaceshipMovement()
    for part, bodyVelocity in pairs(_G.spaceshipVelocities) do
        if bodyVelocity and bodyVelocity.Parent then
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
    end
    _G.currentMoveDirection = nil
end

-- æ›´æ–°é£èˆ¹æ¨¡å¼é€Ÿåº¦ï¼ˆä¸æ”¹å˜æ–¹å‘ï¼‰
local function UpdateSpaceshipSpeed()
    if not _G.spaceshipMode or not _G.currentMoveDirection then return end

    -- ä½¿ç”¨å½“å‰ç§»åŠ¨æ–¹å‘é‡æ–°è®¡ç®—é€Ÿåº¦ï¼Œä½†ä¸æ”¹å˜æ–¹å‘
    MoveSpaceship(_G.currentMoveDirection)
end

-- é€€å‡ºé£èˆ¹æ¨¡å¼
local function ExitSpaceshipMode()
    _G.spaceshipMode = false
    _G.currentMoveDirection = nil

    -- åœæ­¢æ‰€æœ‰ç§»åŠ¨
    StopSpaceshipMovement()

    -- æ¸…ç†BodyVelocityã€BodyGyroå¹¶é‡æ–°å›ºå®šç‰©ä½“
    for part, bodyVelocity in pairs(_G.spaceshipVelocities) do
        if bodyVelocity and bodyVelocity.Parent then
            bodyVelocity:Destroy()
        end
    end

    for part, bodyGyro in pairs(_G.spaceshipGyros) do
        if bodyGyro and bodyGyro.Parent then
            bodyGyro:Destroy()
        end
    end

    -- é‡æ–°å›ºå®šç‰©ä½“
    for part, _ in pairs(_G.fixedParts) do
        if part and part.Parent then
            part.Anchored = true
        end
    end

    _G.spaceshipVelocities = {}
    _G.spaceshipGyros = {}
end

-- ä½¿GUIå…ƒç´ å¯æ‹–åŠ¨çš„å‡½æ•°
local function MakeDraggable(gui)
    gui.Active = true
    gui.Draggable = true
end

-- ç¿»è½¬æ£€æµ‹å’Œè‡ªåŠ¨åœæ­¢ç³»ç»Ÿ
local function SetupFlipDetection()
    RunService.Heartbeat:Connect(function()
        local currentTime = tick()

        for part, flipData in pairs(_G.activeFlips) do
            if part and part.Parent and flipData.angularVelocity and flipData.angularVelocity.Parent then
                -- è®¡ç®—å·²ç»æ—‹è½¬çš„æ—¶é—´
                local elapsedTime = currentTime - flipData.startTime

                -- è®¡ç®—åº”è¯¥æ—‹è½¬çš„è§’åº¦
                local expectedAngle = math.abs(flipData.angularVelocity.AngularVelocity.X + 
                                              flipData.angularVelocity.AngularVelocity.Y + 
                                              flipData.angularVelocity.AngularVelocity.Z) * elapsedTime

                -- å¦‚æœæ—‹è½¬è§’åº¦è¾¾åˆ°æˆ–è¶…è¿‡ç›®æ ‡è§’åº¦ï¼Œåœæ­¢ç¿»è½¬
                if expectedAngle >= math.abs(flipData.targetAngle) then
                    flipData.angularVelocity.AngularVelocity = Vector3.new(0, 0, 0)
                    _G.activeFlips[part] = nil
                    _G.flipAngularVelocities[part] = nil
                end
            else
                -- å¦‚æœéƒ¨ä»¶æˆ–è§’é€Ÿåº¦ä¸å­˜åœ¨ï¼Œæ¸…ç†æ•°æ®
                _G.activeFlips[part] = nil
                _G.flipAngularVelocities[part] = nil
            end
        end
    end)
end

-- åˆå§‹åŒ–ç¿»è½¬æ£€æµ‹ç³»ç»Ÿ
SetupFlipDetection()

-- åˆ›å»ºæ‰‹æœºå‹å¥½çš„GUI
local function CreateMobileGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SingleObjectFloatingControl"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    -- é€‰æ‹©æ¨¡å¼å¼€å…³æŒ‰é’® - å³ä¸Šè§’
    local selectModeButton = Instance.new("TextButton")
    selectModeButton.Name = "SelectModeToggle"
    selectModeButton.Size = UDim2.new(0, 150, 0, 40)
    selectModeButton.Position = UDim2.new(1, -160, 0, 10)
    selectModeButton.Text = "é€‰æ‹©æ¨¡å¼: å…³é—­"
    selectModeButton.TextSize = 14
    selectModeButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    selectModeButton.TextColor3 = Color3.new(1, 1, 1)
    selectModeButton.Parent = screenGui

    MakeDraggable(selectModeButton)

    -- è·ç¦»å’Œé€Ÿåº¦æ§åˆ¶UI - ç¼©å°å°ºå¯¸å¹¶æ·»åŠ é€Ÿåº¦æ§åˆ¶
    local controlPanel = Instance.new("Frame")
    controlPanel.Name = "DistanceSpeedPanel"
    controlPanel.Size = UDim2.new(0, 180, 0, 100) -- ç¼©å°å®½åº¦ï¼Œå¢åŠ é«˜åº¦ä»¥å®¹çº³é€Ÿåº¦æ§åˆ¶
    controlPanel.Position = UDim2.new(0.5, -90, 0, 10)
    controlPanel.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    controlPanel.BackgroundTransparency = 0.3
    controlPanel.BorderSizePixel = 0
    controlPanel.Visible = false
    controlPanel.Parent = screenGui

    MakeDraggable(controlPanel)

    -- è·ç¦»æ§åˆ¶éƒ¨åˆ†
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "DistanceLabel"
    distanceLabel.Size = UDim2.new(1, 0, 0, 25)
    distanceLabel.Position = UDim2.new(0, 0, 0, 0)
    distanceLabel.Text = "è·ç¦»: " .. _G.followDistance
    distanceLabel.TextColor3 = Color3.new(1, 1, 1)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.TextSize = 14 -- ç¼©å°å­—ä½“
    distanceLabel.Parent = controlPanel

    local distanceDownButton = Instance.new("TextButton")
    distanceDownButton.Name = "DistanceDown"
    distanceDownButton.Size = UDim2.new(0, 50, 0, 25) -- ç¼©å°æŒ‰é’®
    distanceDownButton.Position = UDim2.new(0, 10, 0, 25)
    distanceDownButton.Text = "-"
    distanceDownButton.TextSize = 16
    distanceDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    distanceDownButton.TextColor3 = Color3.new(1, 1, 1)
    distanceDownButton.Parent = controlPanel

    local distanceUpButton = Instance.new("TextButton")
    distanceUpButton.Name = "DistanceUp"
    distanceUpButton.Size = UDim2.new(0, 50, 0, 25) -- ç¼©å°æŒ‰é’®
    distanceUpButton.Position = UDim2.new(1, -60, 0, 25)
    distanceUpButton.Text = "+"
    distanceUpButton.TextSize = 16
    distanceUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    distanceUpButton.TextColor3 = Color3.new(1, 1, 1)
    distanceUpButton.Parent = controlPanel

    -- é€Ÿåº¦æ§åˆ¶éƒ¨åˆ† - æ–°å¢ï¼Œä¸Šé™æ”¹ä¸º300
    local speedLabel = Instance.new("TextLabel")
    speedLabel.Name = "SpeedLabel"
    speedLabel.Size = UDim2.new(1, 0, 0, 25)
    speedLabel.Position = UDim2.new(0, 0, 0, 50)
    speedLabel.Text = "é€Ÿåº¦: " .. _G.floatSpeed
    speedLabel.TextColor3 = Color3.new(1, 1, 1)
    speedLabel.BackgroundTransparency = 1
    speedLabel.TextSize = 14 -- ç¼©å°å­—ä½“
    speedLabel.Parent = controlPanel

    local speedDownButton = Instance.new("TextButton")
    speedDownButton.Name = "SpeedDown"
    speedDownButton.Size = UDim2.new(0, 50, 0, 25) -- ç¼©å°æŒ‰é’®
    speedDownButton.Position = UDim2.new(0, 10, 0, 75)
    speedDownButton.Text = "-5"
    speedDownButton.TextSize = 14
    speedDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    speedDownButton.TextColor3 = Color3.new(1, 1, 1)
    speedDownButton.Parent = controlPanel

    local speedUpButton = Instance.new("TextButton")
    speedUpButton.Name = "SpeedUp"
    speedUpButton.Size = UDim2.new(0, 50, 0, 25) -- ç¼©å°æŒ‰é’®
    speedUpButton.Position = UDim2.new(1, -60, 0, 75)
    speedUpButton.Text = "+5"
    speedUpButton.TextSize = 14
    speedUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    speedUpButton.TextColor3 = Color3.new(1, 1, 1)
    speedUpButton.Parent = controlPanel

    -- ä¸»æ§åˆ¶é¢æ¿
    local mainControlPanel = Instance.new("Frame")
    mainControlPanel.Name = "MainControlPanel"
    mainControlPanel.Size = UDim2.new(0, 320, 0, 400)
    mainControlPanel.Position = UDim2.new(0.5, -160, 0.5, -200)
    mainControlPanel.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    mainControlPanel.BackgroundTransparency = 0.3
    mainControlPanel.BorderSizePixel = 0
    mainControlPanel.Visible = false
    mainControlPanel.Parent = screenGui

    MakeDraggable(mainControlPanel)

    -- UIç¼©æ”¾æ§åˆ¶
    local uiScale = Instance.new("UIScale")
    uiScale.Scale = 1.0
    uiScale.Parent = mainControlPanel

    -- åŠ¨ä½œæŒ‰é’®
    local fixButton = Instance.new("TextButton")
    fixButton.Name = "FixButton"
    fixButton.Size = UDim2.new(0, 140, 0, 40)
    fixButton.Position = UDim2.new(0.05, 0, 0, 20)
    fixButton.Text = "å›ºå®šç‰©ä½“"
    fixButton.TextSize = 16
    fixButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    fixButton.TextColor3 = Color3.new(1, 1, 1)
    fixButton.Parent = mainControlPanel

    local unfixButton = Instance.new("TextButton")
    unfixButton.Name = "UnfixButton"
    unfixButton.Size = UDim2.new(0, 140, 0, 40)
    unfixButton.Position = UDim2.new(0.55, 0, 0, 20)
    unfixButton.Text = "è§£é™¤å›ºå®š"
    unfixButton.TextSize = 16
    unfixButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    unfixButton.TextColor3 = Color3.new(1, 1, 1)
    unfixButton.Parent = mainControlPanel

    -- ç¿»è½¬æ§åˆ¶æ ‡é¢˜
    local flipLabel = Instance.new("TextLabel")
    flipLabel.Name = "FlipLabel"
    flipLabel.Size = UDim2.new(1, 0, 0, 30)
    flipLabel.Position = UDim2.new(0, 0, 0, 80)
    flipLabel.Text = "ç¿»è½¬æ§åˆ¶ (è§’åº¦: " .. _G.flipAngle .. "Â°)"
    flipLabel.TextColor3 = Color3.new(1, 1, 1)
    flipLabel.BackgroundTransparency = 1
    flipLabel.TextSize = 18
    flipLabel.Parent = mainControlPanel

    -- ç¿»è½¬è§’åº¦æ§åˆ¶
    local flipAngleDownButton = Instance.new("TextButton")
    flipAngleDownButton.Name = "FlipAngleDown"
    flipAngleDownButton.Size = UDim2.new(0, 30, 0, 30)
    flipAngleDownButton.Position = UDim2.new(0.3, -15, 0, 120)
    flipAngleDownButton.Text = "-"
    flipAngleDownButton.TextSize = 16
    flipAngleDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    flipAngleDownButton.TextColor3 = Color3.new(1, 1, 1)
    flipAngleDownButton.Parent = mainControlPanel

    local flipAngleUpButton = Instance.new("TextButton")
    flipAngleUpButton.Name = "FlipAngleUp"
    flipAngleUpButton.Size = UDim2.new(0, 30, 0, 30)
    flipAngleUpButton.Position = UDim2.new(0.7, -15, 0, 120)
    flipAngleUpButton.Text = "+"
    flipAngleUpButton.TextSize = 16
    flipAngleUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    flipAngleUpButton.TextColor3 = Color3.new(1, 1, 1)
    flipAngleUpButton.Parent = mainControlPanel

    -- ç¿»è½¬æŒ‰é’®
    local flipUpButton = Instance.new("TextButton")
    flipUpButton.Name = "FlipUp"
    flipUpButton.Size = UDim2.new(0, 80, 0, 40)
    flipUpButton.Position = UDim2.new(0.5, -40, 0, 160)
    flipUpButton.Text = "ä¸Šç¿»è½¬"
    flipUpButton.TextSize = 16
    flipUpButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    flipUpButton.TextColor3 = Color3.new(1, 1, 1)
    flipUpButton.Parent = mainControlPanel

    local flipDownButton = Instance.new("TextButton")
    flipDownButton.Name = "FlipDown"
    flipDownButton.Size = UDim2.new(0, 80, 0, 40)
    flipDownButton.Position = UDim2.new(0.5, -40, 0, 210)
    flipDownButton.Text = "ä¸‹ç¿»è½¬"
    flipDownButton.TextSize = 16
    flipDownButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    flipDownButton.TextColor3 = Color3.new(1, 1, 1)
    flipDownButton.Parent = mainControlPanel

    local flipLeftButton = Instance.new("TextButton")
    flipLeftButton.Name = "FlipLeft"
    flipLeftButton.Size = UDim2.new(0, 80, 0, 40)
    flipLeftButton.Position = UDim2.new(0.1, 0, 0, 185)
    flipLeftButton.Text = "å·¦ç¿»è½¬"
    flipLeftButton.TextSize = 16
    flipLeftButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    flipLeftButton.TextColor3 = Color3.new(1, 1, 1)
    flipLeftButton.Parent = mainControlPanel

    local flipRightButton = Instance.new("TextButton")
    flipRightButton.Name = "FlipRight"
    flipRightButton.Size = UDim2.new(0, 80, 0, 40)
    flipRightButton.Position = UDim2.new(0.9, -80, 0, 185)
    flipRightButton.Text = "å³ç¿»è½¬"
    flipRightButton.TextSize = 16
    flipRightButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    flipRightButton.TextColor3 = Color3.new(1, 1, 1)
    flipRightButton.Parent = mainControlPanel

    -- UIç¼©æ”¾æ§åˆ¶
    local scaleLabel = Instance.new("TextLabel")
    scaleLabel.Name = "ScaleLabel"
    scaleLabel.Size = UDim2.new(1, 0, 0, 30)
    scaleLabel.Position = UDim2.new(0, 0, 0, 270)
    scaleLabel.Text = "UIå¤§å°: 1.0"
    scaleLabel.TextColor3 = Color3.new(1, 1, 1)
    scaleLabel.BackgroundTransparency = 1
    scaleLabel.TextSize = 16
    scaleLabel.Parent = mainControlPanel

    local scaleDownButton = Instance.new("TextButton")
    scaleDownButton.Name = "ScaleDown"
    scaleDownButton.Size = UDim2.new(0, 60, 0, 30)
    scaleDownButton.Position = UDim2.new(0.3, -30, 0, 300)
    scaleDownButton.Text = "-"
    scaleDownButton.TextSize = 20
    scaleDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    scaleDownButton.TextColor3 = Color3.new(1, 1, 1)
    scaleDownButton.Parent = mainControlPanel

    local scaleUpButton = Instance.new("TextButton")
    scaleUpButton.Name = "ScaleUp"
    scaleUpButton.Size = UDim2.new(0, 60, 0, 30)
    scaleUpButton.Position = UDim2.new(0.7, -30, 0, 300)
    scaleUpButton.Text = "+"
    scaleUpButton.TextSize = 20
    scaleUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    scaleUpButton.TextColor3 = Color3.new(1, 1, 1)
    scaleUpButton.Parent = mainControlPanel

    -- é£èˆ¹æ¨¡å¼æŒ‰é’®
    local spaceshipButton = Instance.new("TextButton")
    spaceshipButton.Name = "SpaceshipMode"
    spaceshipButton.Size = UDim2.new(0, 140, 0, 40)
    spaceshipButton.Position = UDim2.new(0.05, 0, 0, 340)
    spaceshipButton.Text = "å¼€å¯é£èˆ¹æ¨¡å¼"
    spaceshipButton.TextSize = 14
    spaceshipButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
    spaceshipButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipButton.Parent = mainControlPanel

    -- å…³é—­é¢æ¿æŒ‰é’®
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "ClosePanel"
    closeButton.Size = UDim2.new(0, 140, 0, 40)
    closeButton.Position = UDim2.new(0.55, 0, 0, 340)
    closeButton.Text = "å…³é—­é¢æ¿"
    closeButton.TextSize = 16
    closeButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
    closeButton.TextColor3 = Color3.new(1, 1, 1)
    closeButton.Parent = mainControlPanel

    -- æ‰“å¼€é¢æ¿æŒ‰é’® - å³ä¸Šè§’
    local openPanelButton = Instance.new("TextButton")
    openPanelButton.Name = "OpenPanel"
    openPanelButton.Size = UDim2.new(0, 120, 0, 40)
    openPanelButton.Position = UDim2.new(1, -160, 0, 60)
    openPanelButton.Text = "æ‰“å¼€æ§åˆ¶é¢æ¿"
    openPanelButton.TextSize = 14
    openPanelButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    openPanelButton.TextColor3 = Color3.new(1, 1, 1)
    openPanelButton.Visible = true
    openPanelButton.Parent = screenGui

    MakeDraggable(openPanelButton)

    -- é£èˆ¹æ¨¡å¼UI - ä¼˜åŒ–å¸ƒå±€ï¼Œåˆ é™¤ç¿»è½¬ç›¸å…³æ§ä»¶
    local spaceshipPanel = Instance.new("Frame")
    spaceshipPanel.Name = "SpaceshipPanel"
    spaceshipPanel.Size = UDim2.new(0, 350, 0, 500) -- å‡å°é«˜åº¦ï¼Œå› ä¸ºåˆ é™¤äº†ç¿»è½¬æ§ä»¶
    spaceshipPanel.Position = UDim2.new(0.5, -175, 0.5, -250)
    spaceshipPanel.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    spaceshipPanel.BackgroundTransparency = 0.3
    spaceshipPanel.BorderSizePixel = 0
    spaceshipPanel.Visible = false
    spaceshipPanel.Parent = screenGui

    MakeDraggable(spaceshipPanel)

    -- é£èˆ¹æ¨¡å¼UIç¼©æ”¾æ§åˆ¶
    local spaceshipUIScale = Instance.new("UIScale")
    spaceshipUIScale.Scale = 1.0
    spaceshipUIScale.Parent = spaceshipPanel

    -- é£èˆ¹æ¨¡å¼æ ‡é¢˜
    local spaceshipTitle = Instance.new("TextLabel")
    spaceshipTitle.Name = "SpaceshipTitle"
    spaceshipTitle.Size = UDim2.new(1, 0, 0, 40)
    spaceshipTitle.Position = UDim2.new(0, 0, 0, 10)
    spaceshipTitle.Text = "é£èˆ¹æ¨¡å¼æ§åˆ¶"
    spaceshipTitle.TextColor3 = Color3.new(1, 1, 1)
    spaceshipTitle.BackgroundTransparency = 1
    spaceshipTitle.TextSize = 20
    spaceshipTitle.TextScaled = false
    spaceshipTitle.Parent = spaceshipPanel

    -- é€Ÿåº¦æ§åˆ¶ - ä¸Šé™æ”¹ä¸º300
    local spaceshipSpeedLabel = Instance.new("TextLabel")
    spaceshipSpeedLabel.Name = "SpaceshipSpeedLabel"
    spaceshipSpeedLabel.Size = UDim2.new(1, 0, 0, 30)
    spaceshipSpeedLabel.Position = UDim2.new(0, 0, 0, 60)
    spaceshipSpeedLabel.Text = "é€Ÿåº¦: " .. _G.spaceshipSpeed
    spaceshipSpeedLabel.TextColor3 = Color3.new(1, 1, 1)
    spaceshipSpeedLabel.BackgroundTransparency = 1
    spaceshipSpeedLabel.TextSize = 18
    spaceshipSpeedLabel.Parent = spaceshipPanel

    local spaceshipSpeedDownButton = Instance.new("TextButton")
    spaceshipSpeedDownButton.Name = "SpaceshipSpeedDown"
    spaceshipSpeedDownButton.Size = UDim2.new(0, 40, 0, 30)
    spaceshipSpeedDownButton.Position = UDim2.new(0.3, -20, 0, 100)
    spaceshipSpeedDownButton.Text = "-"
    spaceshipSpeedDownButton.TextSize = 16
    spaceshipSpeedDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    spaceshipSpeedDownButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipSpeedDownButton.Parent = spaceshipPanel

    local spaceshipSpeedUpButton = Instance.new("TextButton")
    spaceshipSpeedUpButton.Name = "SpaceshipSpeedUp"
    spaceshipSpeedUpButton.Size = UDim2.new(0, 40, 0, 30)
    spaceshipSpeedUpButton.Position = UDim2.new(0.7, -20, 0, 100)
    spaceshipSpeedUpButton.Text = "+"
    spaceshipSpeedUpButton.TextSize = 16
    spaceshipSpeedUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    spaceshipSpeedUpButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipSpeedUpButton.Parent = spaceshipPanel

    -- é£èˆ¹æ¨¡å¼ç§»åŠ¨æ§åˆ¶ - é‡æ–°è®¾è®¡å¸ƒå±€ï¼Œåˆ é™¤ç¿»è½¬éƒ¨åˆ†
    local spaceshipMoveUpButton = Instance.new("TextButton")
    spaceshipMoveUpButton.Name = "SpaceshipMoveUp"
    spaceshipMoveUpButton.Size = UDim2.new(0, 80, 0, 40)
    spaceshipMoveUpButton.Position = UDim2.new(0.5, -40, 0, 150)
    spaceshipMoveUpButton.Text = "ä¸Šå‡"
    spaceshipMoveUpButton.TextSize = 16
    spaceshipMoveUpButton.BackgroundColor3 = Color3.fromRGB(150, 150, 0)
    spaceshipMoveUpButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipMoveUpButton.Parent = spaceshipPanel

    local spaceshipMoveForwardButton = Instance.new("TextButton")
    spaceshipMoveForwardButton.Name = "SpaceshipMoveForward"
    spaceshipMoveForwardButton.Size = UDim2.new(0, 100, 0, 40)
    spaceshipMoveForwardButton.Position = UDim2.new(0.5, -50, 0, 200)
    spaceshipMoveForwardButton.Text = "å‰è¿›"
    spaceshipMoveForwardButton.TextSize = 16
    spaceshipMoveForwardButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
    spaceshipMoveForwardButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipMoveForwardButton.Parent = spaceshipPanel

    local spaceshipMoveDownButton = Instance.new("TextButton")
    spaceshipMoveDownButton.Name = "SpaceshipMoveDown"
    spaceshipMoveDownButton.Size = UDim2.new(0, 80, 0, 40)
    spaceshipMoveDownButton.Position = UDim2.new(0.5, -40, 0, 250)
    spaceshipMoveDownButton.Text = "ä¸‹é™"
    spaceshipMoveDownButton.TextSize = 16
    spaceshipMoveDownButton.BackgroundColor3 = Color3.fromRGB(150, 150, 0)
    spaceshipMoveDownButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipMoveDownButton.Parent = spaceshipPanel

    local spaceshipMoveLeftButton = Instance.new("TextButton")
    spaceshipMoveLeftButton.Name = "SpaceshipMoveLeft"
    spaceshipMoveLeftButton.Size = UDim2.new(0, 80, 0, 40)
    spaceshipMoveLeftButton.Position = UDim2.new(0.2, -40, 0, 200)
    spaceshipMoveLeftButton.Text = "å·¦ç§»"
    spaceshipMoveLeftButton.TextSize = 16
    spaceshipMoveLeftButton.BackgroundColor3 = Color3.fromRGB(0, 0, 150)
    spaceshipMoveLeftButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipMoveLeftButton.Parent = spaceshipPanel

    local spaceshipMoveRightButton = Instance.new("TextButton")
    spaceshipMoveRightButton.Name = "SpaceshipMoveRight"
    spaceshipMoveRightButton.Size = UDim2.new(0, 80, 0, 40)
    spaceshipMoveRightButton.Position = UDim2.new(0.8, -40, 0, 200)
    spaceshipMoveRightButton.Text = "å³ç§»"
    spaceshipMoveRightButton.TextSize = 16
    spaceshipMoveRightButton.BackgroundColor3 = Color3.fromRGB(0, 0, 150)
    spaceshipMoveRightButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipMoveRightButton.Parent = spaceshipPanel

    local spaceshipMoveBackwardButton = Instance.new("TextButton")
    spaceshipMoveBackwardButton.Name = "SpaceshipMoveBackward"
    spaceshipMoveBackwardButton.Size = UDim2.new(0, 100, 0, 40)
    spaceshipMoveBackwardButton.Position = UDim2.new(0.5, -50, 0, 300)
    spaceshipMoveBackwardButton.Text = "åé€€"
    spaceshipMoveBackwardButton.TextSize = 16
    spaceshipMoveBackwardButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    spaceshipMoveBackwardButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipMoveBackwardButton.Parent = spaceshipPanel

    -- é£èˆ¹æ¨¡å¼UIç¼©æ”¾æ§åˆ¶
    local spaceshipScaleLabel = Instance.new("TextLabel")
    spaceshipScaleLabel.Name = "SpaceshipScaleLabel"
    spaceshipScaleLabel.Size = UDim2.new(1, 0, 0, 30)
    spaceshipScaleLabel.Position = UDim2.new(0, 0, 0, 350)
    spaceshipScaleLabel.Text = "UIå¤§å°: 1.0"
    spaceshipScaleLabel.TextColor3 = Color3.new(1, 1, 1)
    spaceshipScaleLabel.BackgroundTransparency = 1
    spaceshipScaleLabel.TextSize = 16
    spaceshipScaleLabel.Parent = spaceshipPanel

    local spaceshipScaleDownButton = Instance.new("TextButton")
    spaceshipScaleDownButton.Name = "SpaceshipScaleDown"
    spaceshipScaleDownButton.Size = UDim2.new(0, 60, 0, 30)
    spaceshipScaleDownButton.Position = UDim2.new(0.3, -30, 0, 380)
    spaceshipScaleDownButton.Text = "-"
    spaceshipScaleDownButton.TextSize = 20
    spaceshipScaleDownButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    spaceshipScaleDownButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipScaleDownButton.Parent = spaceshipPanel

    local spaceshipScaleUpButton = Instance.new("TextButton")
    spaceshipScaleUpButton.Name = "SpaceshipScaleUp"
    spaceshipScaleUpButton.Size = UDim2.new(0, 60, 0, 30)
    spaceshipScaleUpButton.Position = UDim2.new(0.7, -30, 0, 380)
    spaceshipScaleUpButton.Text = "+"
    spaceshipScaleUpButton.TextSize = 20
    spaceshipScaleUpButton.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
    spaceshipScaleUpButton.TextColor3 = Color3.new(1, 1, 1)
    spaceshipScaleUpButton.Parent = spaceshipPanel

    -- å…³é—­é£èˆ¹æ¨¡å¼æŒ‰é’® - è°ƒæ•´åˆ°å·¦è¾¹
    local closeSpaceshipButton = Instance.new("TextButton")
    closeSpaceshipButton.Name = "CloseSpaceship"
    closeSpaceshipButton.Size = UDim2.new(0, 140, 0, 40)
    closeSpaceshipButton.Position = UDim2.new(0.05, 0, 0, 420) -- è°ƒæ•´åˆ°å·¦è¾¹
    closeSpaceshipButton.Text = "å…³é—­é£èˆ¹æ¨¡å¼"
    closeSpaceshipButton.TextSize = 16
    closeSpaceshipButton.BackgroundColor3 = Color3.fromRGB(200, 100, 100)
    closeSpaceshipButton.TextColor3 = Color3.new(1, 1, 1)
    closeSpaceshipButton.Parent = spaceshipPanel

    -- æ–°å¢ï¼šåœæ­¢ç§»åŠ¨æŒ‰é’® - æ”¾åœ¨å…³é—­é£èˆ¹æ¨¡å¼æŒ‰é’®å³è¾¹
    local stopMovementButton = Instance.new("TextButton")
    stopMovementButton.Name = "StopMovement"
    stopMovementButton.Size = UDim2.new(0, 140, 0, 40)
    stopMovementButton.Position = UDim2.new(0.55, 0, 0, 420) -- æ”¾åœ¨å³è¾¹
    stopMovementButton.Text = "åœæ­¢ç§»åŠ¨"
    stopMovementButton.TextSize = 16
    stopMovementButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
    stopMovementButton.TextColor3 = Color3.new(1, 1, 1)
    stopMovementButton.Parent = spaceshipPanel

    -- æ–°å¢ï¼šéšè—/æ˜¾ç¤ºé£èˆ¹æ¨¡å¼UIæŒ‰é’® - æ”¾åœ¨é€‰æ‹©æ¨¡å¼æŒ‰é’®ä¸‹æ–¹
    local toggleSpaceshipUIButton = Instance.new("TextButton")
    toggleSpaceshipUIButton.Name = "ToggleSpaceshipUI"
    toggleSpaceshipUIButton.Size = UDim2.new(0, 150, 0, 40)
    toggleSpaceshipUIButton.Position = UDim2.new(1, -160, 0, 110) -- åœ¨é€‰æ‹©æ¨¡å¼æŒ‰é’®ä¸‹æ–¹
    toggleSpaceshipUIButton.Text = "éšè—é£èˆ¹æ¨¡å¼UI"
    toggleSpaceshipUIButton.TextSize = 14
    toggleSpaceshipUIButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)
    toggleSpaceshipUIButton.TextColor3 = Color3.new(1, 1, 1)
    toggleSpaceshipUIButton.Visible = false -- åˆå§‹ä¸å¯è§
    toggleSpaceshipUIButton.Parent = screenGui

    MakeDraggable(toggleSpaceshipUIButton)

    -- é€‰æ‹©æ¨¡å¼çŠ¶æ€
    local selectMode = false

    -- é¼ æ ‡ç‚¹å‡»äº‹ä»¶å¤„ç†
    local function onMouseClick()
        if not selectMode then return end

        local targetPart = getTargetPart()
        if targetPart then
            SelectPart(targetPart)
        end
    end

    -- è¿æ¥é¼ æ ‡ç‚¹å‡»äº‹ä»¶
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end

        if input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch then
            onMouseClick()
        end
    end)

    -- è·ç¦»æ§åˆ¶åŠŸèƒ½ - ä¿®æ”¹ä¸Šé™ä¸º300
    distanceUpButton.MouseButton1Click:Connect(function()
        _G.followDistance = math.min(_G.followDistance + 1, 300)
        distanceLabel.Text = "è·ç¦»: " .. _G.followDistance
    end)

    distanceDownButton.MouseButton1Click:Connect(function()
        _G.followDistance = math.max(_G.followDistance - 1, 1)
        distanceLabel.Text = "è·ç¦»: " .. _G.followDistance
    end)

    -- é€Ÿåº¦æ§åˆ¶åŠŸèƒ½ - æ–°å¢ï¼Œä¸Šé™æ”¹ä¸º300
    speedUpButton.MouseButton1Click:Connect(function()
        _G.floatSpeed = math.min(_G.floatSpeed + 5, 300)  -- ä¸Šé™æ”¹ä¸º300
        speedLabel.Text = "é€Ÿåº¦: " .. _G.floatSpeed
    end)

    speedDownButton.MouseButton1Click:Connect(function()
        _G.floatSpeed = math.max(_G.floatSpeed - 5, 1)
        speedLabel.Text = "é€Ÿåº¦: " .. _G.floatSpeed
    end)

    -- å›ºå®šæŒ‰é’®åŠŸèƒ½
    fixButton.MouseButton1Click:Connect(function()
        if FixPart() then
            controlPanel.Visible = false
        end
    end)

    -- è§£é™¤å›ºå®šæŒ‰é’®åŠŸèƒ½
    unfixButton.MouseButton1Click:Connect(function()
        if UnfixPart() then
            controlPanel.Visible = true
        end
    end)

    -- ç¿»è½¬è§’åº¦æ§åˆ¶
    flipAngleUpButton.MouseButton1Click:Connect(function()
        _G.flipAngle = math.min(_G.flipAngle + 1, 90)
        flipLabel.Text = "ç¿»è½¬æ§åˆ¶ (è§’åº¦: " .. _G.flipAngle .. "Â°)"
    end)

    flipAngleDownButton.MouseButton1Click:Connect(function()
        _G.flipAngle = math.max(_G.flipAngle - 1, 1)
        flipLabel.Text = "ç¿»è½¬æ§åˆ¶ (è§’åº¦: " .. _G.flipAngle .. "Â°)"
    end)

    -- ç¿»è½¬æ§åˆ¶åŠŸèƒ½
    flipUpButton.MouseButton1Click:Connect(function()
        ApplyFlip("X", _G.flipAngle)
    end)

    flipDownButton.MouseButton1Click:Connect(function()
        ApplyFlip("X", -_G.flipAngle)
    end)

    flipLeftButton.MouseButton1Click:Connect(function()
        ApplyFlip("Y", _G.flipAngle)
    end)

    flipRightButton.MouseButton1Click:Connect(function()
        ApplyFlip("Y", -_G.flipAngle)
    end)

    -- UIç¼©æ”¾åŠŸèƒ½
    scaleUpButton.MouseButton1Click:Connect(function()
        uiScale.Scale = math.min(uiScale.Scale + 0.1, 1.5)
        scaleLabel.Text = "UIå¤§å°: " .. string.format("%.1f", uiScale.Scale)
    end)

    scaleDownButton.MouseButton1Click:Connect(function()
        uiScale.Scale = math.max(uiScale.Scale - 0.1, 0.5)
        scaleLabel.Text = "UIå¤§å°: " .. string.format("%.1f", uiScale.Scale)
    end)

    -- é£èˆ¹æ¨¡å¼é€Ÿåº¦æ§åˆ¶ - ä¿®å¤ï¼šåªæ›´æ–°é€Ÿåº¦ï¼Œä¸æ”¹å˜æ–¹å‘
    spaceshipSpeedUpButton.MouseButton1Click:Connect(function()
        _G.spaceshipSpeed = math.min(_G.spaceshipSpeed + 5, 300)  -- ä¸Šé™æ”¹ä¸º300
        spaceshipSpeedLabel.Text = "é€Ÿåº¦: " .. _G.spaceshipSpeed

        -- å¦‚æœé£èˆ¹æ¨¡å¼æ­£åœ¨è¿è¡Œä¸”æœ‰ç§»åŠ¨æ–¹å‘ï¼Œåªæ›´æ–°é€Ÿåº¦ä¸æ”¹å˜æ–¹å‘
        if _G.spaceshipMode and _G.currentMoveDirection then
            UpdateSpaceshipSpeed()
        end
    end)

    spaceshipSpeedDownButton.MouseButton1Click:Connect(function()
        _G.spaceshipSpeed = math.max(_G.spaceshipSpeed - 5, 1)
        spaceshipSpeedLabel.Text = "é€Ÿåº¦: " .. _G.spaceshipSpeed

        -- å¦‚æœé£èˆ¹æ¨¡å¼æ­£åœ¨è¿è¡Œä¸”æœ‰ç§»åŠ¨æ–¹å‘ï¼Œåªæ›´æ–°é€Ÿåº¦ä¸æ”¹å˜æ–¹å‘
        if _G.spaceshipMode and _G.currentMoveDirection then
            UpdateSpaceshipSpeed()
        end
    end)

    -- é£èˆ¹æ¨¡å¼ç§»åŠ¨æ§åˆ¶ - ä½¿ç”¨åŸºäºè§†è§’çš„æ–¹å‘
    spaceshipMoveForwardButton.MouseButton1Click:Connect(function()
        MoveSpaceship("forward")
    end)

    spaceshipMoveBackwardButton.MouseButton1Click:Connect(function()
        MoveSpaceship("backward")
    end)

    spaceshipMoveLeftButton.MouseButton1Click:Connect(function()
        MoveSpaceship("left")
    end)

    spaceshipMoveRightButton.MouseButton1Click:Connect(function()
        MoveSpaceship("right")
    end)

    spaceshipMoveUpButton.MouseButton1Click:Connect(function()
        MoveSpaceship("up")
    end)

    spaceshipMoveDownButton.MouseButton1Click:Connect(function()
        MoveSpaceship("down")
    end)

    -- é£èˆ¹æ¨¡å¼UIç¼©æ”¾åŠŸèƒ½
    spaceshipScaleUpButton.MouseButton1Click:Connect(function()
        spaceshipUIScale.Scale = math.min(spaceshipUIScale.Scale + 0.1, 1.5)
        spaceshipScaleLabel.Text = "UIå¤§å°: " .. string.format("%.1f", spaceshipUIScale.Scale)
    end)

    spaceshipScaleDownButton.MouseButton1Click:Connect(function()
        spaceshipUIScale.Scale = math.max(spaceshipUIScale.Scale - 0.1, 0.5)
        spaceshipScaleLabel.Text = "UIå¤§å°: " .. string.format("%.1f", spaceshipUIScale.Scale)
    end)

    -- é€‰æ‹©æ¨¡å¼å¼€å…³åŠŸèƒ½
    selectModeButton.MouseButton1Click:Connect(function()
        selectMode = not selectMode
        if selectMode then
            selectModeButton.Text = "é€‰æ‹©æ¨¡å¼: å¼€å¯"
            selectModeButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            print("é€‰æ‹©æ¨¡å¼å·²å¼€å¯")
        else
            selectModeButton.Text = "é€‰æ‹©æ¨¡å¼: å…³é—­"
            selectModeButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            print("é€‰æ‹©æ¨¡å¼å·²å…³é—­")
        end
    end)

    -- é£èˆ¹æ¨¡å¼å¼€å…³åŠŸèƒ½
    spaceshipButton.MouseButton1Click:Connect(function()
        -- æ£€æŸ¥æ˜¯å¦æœ‰å›ºå®šçš„ç‰©ä½“
        local hasFixedParts = false
        for _ in pairs(_G.fixedParts) do
            hasFixedParts = true
            break
        end

        if hasFixedParts then
            _G.spaceshipMode = true
            _G.currentMoveDirection = nil
            mainControlPanel.Visible = false
            spaceshipPanel.Visible = true
            openPanelButton.Visible = false
            toggleSpaceshipUIButton.Visible = true -- æ˜¾ç¤ºéšè—é£èˆ¹æ¨¡å¼UIæŒ‰é’®
            print("é£èˆ¹æ¨¡å¼å·²å¼€å¯ï¼Œæ§åˆ¶æ‰€æœ‰å›ºå®šç‰©ä½“")

            -- åˆå§‹åŒ–é£èˆ¹æ¨¡å¼ï¼Œä½†ä¸ç«‹å³ç§»åŠ¨
            for part, _ in pairs(_G.fixedParts) do
                if part and part.Parent then
                    -- å–æ¶ˆå›ºå®šçŠ¶æ€ï¼Œè®©ç‰©ä½“å¯ä»¥ç§»åŠ¨
                    part.Anchored = false

                    -- åˆ›å»ºBodyVelocityä½†ä¸è®¾ç½®é€Ÿåº¦ï¼ˆç­‰å¾…ç§»åŠ¨æŒ‡ä»¤ï¼‰
                    local bodyVelocity = Instance.new("BodyVelocity")
                    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                    bodyVelocity.Velocity = Vector3.new(0, 0, 0) -- åˆå§‹é€Ÿåº¦ä¸º0
                    bodyVelocity.Parent = part
                    _G.spaceshipVelocities[part] = bodyVelocity

                    -- åˆ›å»ºBodyGyroé˜²æ­¢æ—‹è½¬
                    local bodyGyro = Instance.new("BodyGyro")
                    bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
                    bodyGyro.P = 1000
                    bodyGyro.D = 500
                    bodyGyro.CFrame = part.CFrame  -- ä¿æŒå½“å‰æ–¹å‘
                    bodyGyro.Parent = part
                    _G.spaceshipGyros[part] = bodyGyro
                end
            end
        else
            print("æ²¡æœ‰å›ºå®šçš„ç‰©ä½“ï¼Œæ— æ³•å¼€å¯é£èˆ¹æ¨¡å¼")
        end
    end)

    -- å…³é—­é£èˆ¹æ¨¡å¼åŠŸèƒ½
    closeSpaceshipButton.MouseButton1Click:Connect(function()
        ExitSpaceshipMode()
        spaceshipPanel.Visible = false
        openPanelButton.Visible = true
        toggleSpaceshipUIButton.Visible = false -- éšè—éšè—é£èˆ¹æ¨¡å¼UIæŒ‰é’®
        print("é£èˆ¹æ¨¡å¼å·²å…³é—­")
    end)

    -- æ–°å¢ï¼šéšè—/æ˜¾ç¤ºé£èˆ¹æ¨¡å¼UIæŒ‰é’®åŠŸèƒ½
    toggleSpaceshipUIButton.MouseButton1Click:Connect(function()
        spaceshipPanel.Visible = not spaceshipPanel.Visible
        if spaceshipPanel.Visible then
            toggleSpaceshipUIButton.Text = "éšè—é£èˆ¹æ¨¡å¼UI"
        else
            toggleSpaceshipUIButton.Text = "æ˜¾ç¤ºé£èˆ¹æ¨¡å¼UI"
        end
    end)

    -- æ–°å¢ï¼šåœæ­¢ç§»åŠ¨æŒ‰é’®åŠŸèƒ½
    stopMovementButton.MouseButton1Click:Connect(function()
        StopSpaceshipMovement()
        print("ç´§æ€¥åˆ¹è½¦ï¼æ‰€æœ‰ç‰©ä½“å·²åœæ­¢ç§»åŠ¨")
    end)

    -- å…³é—­é¢æ¿åŠŸèƒ½
    closeButton.MouseButton1Click:Connect(function()
        mainControlPanel.Visible = false
        openPanelButton.Visible = true
    end)

    -- æ‰“å¼€é¢æ¿åŠŸèƒ½
    openPanelButton.MouseButton1Click:Connect(function()
        mainControlPanel.Visible = true
        openPanelButton.Visible = false
    end)

    -- ç›‘å¬é€‰æ‹©çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°UIæ˜¾ç¤º
    local function updateUI()
        if _G.selectedPart then
            controlPanel.Visible = not _G.isFixed
            mainControlPanel.Visible = mainControlPanel.Visible -- ä¿æŒå½“å‰çŠ¶æ€
        else
            controlPanel.Visible = false
        end
    end

    -- å®šæœŸæ›´æ–°UI
    RunService.Heartbeat:Connect(updateUI)

    return screenGui
end

-- æ·»åŠ é”™è¯¯å¤„ç†
local success, err = pcall(function()
    CreateMobileGUI()
end)

if not success then
    warn("GUIåˆ›å»ºå¤±è´¥: " .. tostring(err))
end